var Answer=function(){function Answer(name,type){this.name=name;this.type=type;this.block_html=new AnswerBlock(name,type);this.length="10";this.sub_type=null}Answer.prototype.get_block_html=function(){return this.block_html};Answer.prototype.get_type=function(){if(this.type!="other")return this.type;else{return $("#ans_"+this.name+"_type").find("textarea").get(0).value}};Answer.prototype.set_sub_type=function(type){this.sub_type=type};Answer.prototype.get_option=function(){var result="";var tab=$("#fieldset_ans_"+this.name).find("input:checked");for(var i=0;i<tab.length;i++){result+=$("#fieldset_ans_"+this.name).find("input:checked").eq(i).val()+","}if(result.length>0){result=result.substring(0,result.length-1);result="{option = "+result+"}"}return result};Answer.prototype.to_OEF=function(){return this.block_html.get_editor().to_OEFcode().split("<p>").join("").split("</p>").join("").split("\n").join("")};return Answer}();var AnswerBlock=function(){function AnswerBlock(name,type){this.all_type={numeric:{coma:Blockly.Msg.WIMS_ANSWER_OPTION_COMA,noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},range:{noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},units:{noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},numexp:{noreduction:Blockly.Msg.WIMS_ANSWER_OPTION_NOREDUCTION,noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},matrix:{noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE,split_coeff:Blockly.Msg.WIMS_ANSWER_OPTION_SPLIT_COEFF,split_column:Blockly.Msg.WIMS_ANSWER_OPTION_SPLIT_COLUMN,split_row:Blockly.Msg.WIMS_ANSWER_OPTION_SPLIT_ROW},correspond:{split:Blockly.Msg.WIMS_ANSWER_OPTION_SPLIT,noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},case:{noreaccent:Blockly.Msg.WIMS_ANSWER_OPTION_NOREACCENT,noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},menu:{split:Blockly.Msg.WIMS_ANSWER_OPTION_SPLIT,shuffle:Blockly.Msg.WIMS_ANSWER_OPTION_SHUFFLE,multiple:Blockly.Msg.WIMS_ANSWER_OPTION_MULTIPLE,sort:Blockly.Msg.WIMS_ANSWER_OPTION_SORT,eqweight:Blockly.Msg.WIMS_ANSWER_OPTION_EQWEIGHT,nolegend:Blockly.Msg.WIMS_ANSWER_OPTION_NOLEGEND,noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},radio:{split:Blockly.Msg.WIMS_ANSWER_OPTION_SPLIT,shuffle:Blockly.Msg.WIMS_ANSWER_OPTION_SHUFFLE,multiple:Blockly.Msg.WIMS_ANSWER_OPTION_MULTIPLE,sort:Blockly.Msg.WIMS_ANSWER_OPTION_SORT,eqweight:Blockly.Msg.WIMS_ANSWER_OPTION_EQWEIGHT,nolegend:Blockly.Msg.WIMS_ANSWER_OPTION_NOLEGEND,noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},click:{split:Blockly.Msg.WIMS_ANSWER_OPTION_SPLIT,shuffle:Blockly.Msg.WIMS_ANSWER_OPTION_SHUFFLE,multiple:Blockly.Msg.WIMS_ANSWER_OPTION_MULTIPLE,sort:Blockly.Msg.WIMS_ANSWER_OPTION_SORT,eqweight:Blockly.Msg.WIMS_ANSWER_OPTION_EQWEIGHT,nolegend:Blockly.Msg.WIMS_ANSWER_OPTION_NOLEGEND,noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},checkbox:{split:Blockly.Msg.WIMS_ANSWER_OPTION_SPLIT,shuffle:Blockly.Msg.WIMS_ANSWER_OPTION_SHUFFLE,show:Blockly.Msg.WIMS_ANSWER_OPTION_SHOW,sort:Blockly.Msg.WIMS_ANSWER_OPTION_SORT,eqweight:Blockly.Msg.WIMS_ANSWER_OPTION_EQWEIGHT,nolegend:Blockly.Msg.WIMS_ANSWER_OPTION_NOLEGEND,noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},flashcard:{split:Blockly.Msg.WIMS_ANSWER_OPTION_SPLIT,shuffle:Blockly.Msg.WIMS_ANSWER_OPTION_SHUFFLE,show:Blockly.Msg.WIMS_ANSWER_OPTION_SHOW,sort:Blockly.Msg.WIMS_ANSWER_OPTION_SORT,eqweight:Blockly.Msg.WIMS_ANSWER_OPTION_EQWEIGHT,nolegend:Blockly.Msg.WIMS_ANSWER_OPTION_NOLEGEND,noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},mark:{split:Blockly.Msg.WIMS_ANSWER_OPTION_SPLIT,shuffle:Blockly.Msg.WIMS_ANSWER_OPTION_SHUFFLE,show:Blockly.Msg.WIMS_ANSWER_OPTION_SHOW,sort:Blockly.Msg.WIMS_ANSWER_OPTION_SORT,eqweight:Blockly.Msg.WIMS_ANSWER_OPTION_EQWEIGHT,nolegend:Blockly.Msg.WIMS_ANSWER_OPTION_NOLEGEND,noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},dragfill:{noorder:Blockly.Msg.WIMS_ANSWER_OPTION_NOORDER,transparent:Blockly.Msg.WIMS_ANSWER_OPTION_TRANSPARENT,noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},clickfill:{noorder:Blockly.Msg.WIMS_ANSWER_OPTION_NOORDER,transparent:Blockly.Msg.WIMS_ANSWER_OPTION_TRANSPARENT,noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},function:{integer:Blockly.Msg.WIMS_ANSWER_OPTION_INTEGER,noanalyze:Blockly.Msg.WIMS_ANSWER_OPTION_NOANALYZE},other:{}};this.name=name;this.html=this.construct_basic_html();$("#answer_list_analyse").append(this.html)}AnswerBlock.prototype.change_to_type=function(type){if(type=="other"){this.html=this.change_html_fieldset(this.generate_fieldset_code(type));this.update_html(true)}else{this.html=this.change_html_fieldset(this.generate_fieldset_code(type));this.update_html(false)}};AnswerBlock.prototype.get_html=function(){return this.html};AnswerBlock.prototype.get_editeur_div_id=function(){return"editor_"+this.name};AnswerBlock.prototype.get_editor=function(){return this.editor};AnswerBlock.prototype.get_div_id_change=function(){return"ans_"+this.id};AnswerBlock.prototype.set_editor=function(editor){this.editor=editor};AnswerBlock.prototype.create_editor=function(){this.editor=new SEditor(new Quill("#"+this.get_editeur_div_id(),{modules:{toolbar:false},placeholder:Blockly.Msg.WIMS_ANSWER_ANALYSIS_STRING_PLACEHOLDER,theme:"snow"}))};AnswerBlock.prototype.destroy=function(){this.html="";this.destroy_html();this.editor=null};AnswerBlock.prototype.construct_basic_html=function(){var result='<div class="large-12 columns callout" id="answer_all_'+this.name+'">'+'<div class="large-11 columns">'+'<div style="text-align:center;"><span class="surligne_Answer_Place">'+'<img src="images/question.png" style="max-height:50px;max-width:50px;"/><span class="surligne_Answer">'+this.name+"</span></span></div>"+"<label>"+Blockly.Msg.WIMS_ANSWER_TYPE+"<select oninput=\"$('#ans_"+this.name+"').removeClass('answer_hidden');change_type_answer('"+this.name+"',this.value,answer_List)\">"+'<option value="numeric">'+Blockly.Msg.WIMS_ANSWER_TYPE_NUMERIC+"</option>"+'<option value="range">'+Blockly.Msg.WIMS_ANSWER_TYPE_RANGE+"</option>"+'<option value="units">'+Blockly.Msg.WIMS_ANSWER_TYPE_UNITS+"</option>"+'<option value="numexp">'+Blockly.Msg.WIMS_ANSWER_TYPE_NUMEXP+"</option>"+'<option value="matrix">'+Blockly.Msg.WIMS_ANSWER_TYPE_MATRIX+"</option>"+'<option value="correspond">'+Blockly.Msg.WIMS_ANSWER_TYPE_CORRESPOND+"</option>"+'<option value="case">'+Blockly.Msg.WIMS_ANSWER_TYPE_CASE+"</option>"+'<option value="menu">'+Blockly.Msg.WIMS_ANSWER_TYPE_MENU+"</option>"+'<option value="radio">'+Blockly.Msg.WIMS_ANSWER_TYPE_RADIO+"</option>"+'<option value="click">'+Blockly.Msg.WIMS_ANSWER_TYPE_CLICK+"</option>"+'<option value="checkbox">'+Blockly.Msg.WIMS_ANSWER_TYPE_CHECKBOX+"</option>"+'<option value="flashcard">'+Blockly.Msg.WIMS_ANSWER_TYPE_FLASHCARD+"</option>"+'<option value="mark">'+Blockly.Msg.WIMS_ANSWER_TYPE_MARK+"</option>"+'<option value="dragfill">'+Blockly.Msg.WIMS_ANSWER_TYPE_DRAGFILL+"</option>"+'<option value="clickfill">'+Blockly.Msg.WIMS_ANSWER_TYPE_CLICKFILL+"</option>"+'<option value="function">'+Blockly.Msg.WIMS_ANSWER_TYPE_FUNCTION+"</option>"+'<option value="coord">'+Blockly.Msg.WIMS_ANSWER_TYPE_COORD+"</option>"+'<option value="other">'+Blockly.Msg.WIMS_ANSWER_TYPE_OTHER+"</option>"+"</select>"+"</label>"+'<div id="ans_'+this.name+'">'+'<div id="ans_'+this.name+'_type"></div>'+Blockly.Msg.WIMS_ANSWER_ANALYSIS_STRING+'<div id="editor_'+this.name+'">'+"</div>"+this.generate_fieldset_code("numeric")+"</div>"+'<div class="large-1 columns">'+'<button class="close-button" onclick="destroy_answer(\''+this.name+'\');update_variables_answers_view(\'card_Analyse_Variable\',variable_List,answer_List)" aria-label="Close alert" type="button">'+'<span aria-hidden="true">&times;</span>'+"</button>"+"</div>"+"</div>"+"</div>";return result};AnswerBlock.prototype.change_html_fieldset=function(str){var result=this.html;var start=this.html.search("<fieldset");var end=this.html.search("</fieldset>");result=this.html.substring(0,start)+str+this.html.substring(end+11,this.html.length);return result};AnswerBlock.prototype.update_html=function(textAreaType){var result="";var start=this.html.search("<fieldset");var end=this.html.search("</fieldset>");result=this.html.substring(start,end+11);$("#fieldset_ans_"+this.name).replaceWith(result);if(textAreaType){$("#ans_"+this.name+"_type").html('<textarea placeholder="Type"></textarea>')}else{$("#ans_"+this.name+"_type").html("")}};AnswerBlock.prototype.destroy_html=function(){$("#answer_all_"+this.name).remove()};AnswerBlock.prototype.update_all_html=function(){$("#answer_all_"+this.name).replaceWith(this.html)};AnswerBlock.prototype.generate_fieldset_code=function(type){var result='<fieldset id="fieldset_ans_'+this.name+'">'+"<legend>"+Blockly.Msg.WIMS_ANSWER_ANALYSIS_OPTIONS+"</legend>";for(var key in this.all_type[type]){result+='<input value="'+key+'" type="checkbox"><label>'+this.all_type[type][key]+"</label>"}result+="</fieldset>";return result};AnswerBlock.prototype.generate_choice_type=function(){var result="<select oninput=\"$('#ans_"+this.name+"').removeClass('answer_hidden');change_type_answer('"+this.name+"',this.value,answer_List)\">";for(var key in this.all_type){result+='<option value="'+key+'">'+key+"</option>"}return result+"</select>"};return AnswerBlock}();var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var Embed=Quill.import("blots/embed");var AnswerImage=function(_super){__extends(AnswerImage,_super);function AnswerImage(){return _super!==null&&_super.apply(this,arguments)||this}AnswerImage.create=function(valueTransfer){var value;var valueTransferObj;try{valueTransferObj=JSON.parse(valueTransfer);if(valueTransferObj&&typeof valueTransferObj==="object"){value=valueTransferObj["value"]}}catch(e){value=valueTransfer}var node=_super.create.call(this,value);var embedInnerHTML=value;node.className="surligne_Answer";if(typeof valueTransferObj!="undefined"){if(valueTransferObj["variable1"]=="editor-enonce"){embedInnerHTML='<img src="images/question.png" style="max-height:60px;max-width:60px;"/><span class="surligne_Answer">'+embedInnerHTML+"</span>";node.className="surligne_Answer_Place"}}node.innerHTML=embedInnerHTML;node.setAttribute("data-value",valueTransfer);node.setAttribute("contenteditable",false);var id=generate_unique_id_answer(value);node.setAttribute("id",id);node.setAttribute("onclick","create_popup_embed_answer('"+id+"','"+value+"');");return node};AnswerImage.value=function(domNode){return domNode.getAttribute("data-value")};AnswerImage.nameFromObject=function(dataString){var valueTransferObj;try{valueTransferObj=JSON.parse(dataString);if(valueTransferObj&&typeof valueTransferObj==="object"){return valueTransferObj["value"]}}catch(e){return dataString}};return AnswerImage}(Embed);AnswerImage.blotName="answerImage";AnswerImage.tagName="span";AnswerImage.className="surligne_Answer_Place";Quill.register({"formats/AnswerImage":AnswerImage});var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var Embed=Quill.import("blots/embed");var VariableImage=function(_super){__extends(VariableImage,_super);function VariableImage(){return _super!==null&&_super.apply(this,arguments)||this}VariableImage.create=function(value){var node=_super.create.call(this,value);node.innerHTML=value;node.setAttribute("data-value",value);node.setAttribute("contenteditable",false);return node};VariableImage.value=function(domNode){return domNode.getAttribute("data-value")};return VariableImage}(Embed);VariableImage.blotName="VariableImage";VariableImage.className="surligne_Variable";VariableImage.tagName="span";Quill.register({"formats/variableImage":VariableImage});var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var Inline=Quill.import("blots/inline");var LatexImage=function(_super){__extends(LatexImage,_super);function LatexImage(){return _super!==null&&_super.apply(this,arguments)||this}LatexImage.create=function(){return _super.create.call(this)};LatexImage.formats=function(){return true};return LatexImage}(Inline);LatexImage.blotName="LatexImage";LatexImage.className="surligne_Latex";LatexImage.tagName="latex";Quill.register({"formats/latexImage":LatexImage});var SEditor=function(){function SEditor(editor){this.editor=editor}SEditor.prototype.to_variable_value=function(){var res=this.to_OEFcode().split("<p>").join("").split("</p>").join("");return res.substring(0,res.length-1)};SEditor.prototype.to_Blockly_Analyse=function(){var tmp=this.to_variable_value();var start=tmp.search("\\embed{");var result="";var end;var vir;while(start!=-1){result+=tmp.substring(0,start-1);tmp=tmp.substring(start);end=tmp.search("}");vir=tmp.search(",");result+="\\"+tmp.substring(6,vir);tmp=tmp.substring(end+1);start=tmp.search("\\embed{")}result+=tmp;return result};SEditor.prototype.to_OEFcode=function(){var content=this.editor.getContents();var tabContent=content["ops"];var line="";var tabTmp=[];var result="";var resTmp;var was_variable=false;var answer_count={value:1};var was_list={ordered:false,unordered:false};for(var i=0;i<tabContent.length;i++){tabTmp=this.cut_insert(tabContent[i]);for(var j=0;j<tabTmp.length;j++){if(tabTmp[j]["insert"]!="\n"){line+=this.add_element_line(tabTmp[j],answer_count,was_variable);was_variable=tabTmp[j]["insert"]["VariableImage"]!=null}else{resTmp=this.applied_attributes(line,tabTmp[j],was_list);was_list=resTmp["was_list"];result+=resTmp["line"];line=""}}}if(line!=""){result+=line}return this.clean_OEFcode(result)};SEditor.prototype.add_variable=function(nameVar){this.editor.focus();var selection=this.editor.getSelection();insert_embed_object(this.editor,selection.index,"VariableImage",nameVar)};SEditor.prototype.add_answer=function(nameAns){this.editor.focus();var selection=this.editor.getSelection();insert_embed_object(this.editor,selection.index,"answerImage",nameAns,this.editor.container.id)};SEditor.prototype.destroy_var=function(varName){var content=this.editor.getContents();var tab=content["ops"];var tabRes=[];for(var i=0;i<content["ops"].length;i++){if(content["ops"][i]["insert"]["VariableImage"]==null||content["ops"][i]["insert"]["VariableImage"]!=varName){tabRes.push(content["ops"][i])}}content["ops"]=tabRes;this.editor.setContents(content)};SEditor.prototype.destroy_answer=function(ansName){var content=this.editor.getContents();var tab=content["ops"];var tabRes=[];for(var i=0;i<content["ops"].length;i++){if(content["ops"][i]["insert"]["answerImage"]==null||AnswerImage.nameFromObject(content["ops"][i]["insert"]["answerImage"])!=ansName){tabRes.push(content["ops"][i])}}content["ops"]=tabRes;this.editor.setContents(content)};SEditor.prototype.change_to_latex=function(){var positionSelection=this.editor.getSelection();if(positionSelection.length==0){if(this.editor.getFormat()["LatexImage"]==true){this.editor.format("LatexImage",false)}else{this.editor.format("LatexImage",true)}}else{if(this.editor.getFormat()["LatexImage"]==true){this.editor.formatText(positionSelection.index,positionSelection.length,"LatexImage",false)}else{this.editor.formatText(positionSelection.index,positionSelection.length,"LatexImage",true)}}};SEditor.prototype.getContents=function(){return this.editor.getContents()};SEditor.prototype.changeNameVar=function(oldname,newName){var content=this.editor.getContents()["ops"];var result=[];for(var i=0;i<content.length;i++){if(content[i]["insert"]["VariableImage"]){if(content[i]["insert"]["VariableImage"]==oldname){result.push({insert:{VariableImage:newName}})}else{result.push(content[i])}}else{result.push(content[i])}}var tmp={ops:result};this.editor.setContents(tmp)};SEditor.prototype.get_answer_tab=function(){var cont=this.editor.getContents()["ops"];var result=[];for(var i=0;i<cont.length;i++){if(cont[i]["insert"]["answerImage"]!=null){result.push(AnswerImage.nameFromObject(cont[i]["insert"]["answerImage"]))}}return result};SEditor.prototype.focus=function(){this.editor.focus()};SEditor.prototype.cut_insert=function(delta_element){if(typeof delta_element["insert"]==="string"){var text=delta_element["insert"];var return_line_search=text.search("\n");var result=[];while(return_line_search!=-1){result.push({insert:text.substring(0,return_line_search),attributes:delta_element["attributes"]});result.push({insert:"\n",attributes:{}});text=text.substring(return_line_search+1);return_line_search=text.search("\n")}if(text.length>0){result.push({insert:text,attributes:delta_element["attributes"]})}if(delta_element["insert"]=="\n"){result=[delta_element]}return result}else{return[delta_element]}};SEditor.prototype.add_element_line=function(element,count_answer,was_variable){var result=element["insert"];if(element["insert"]["VariableImage"]!=null){result="\\"+element["insert"]["VariableImage"]}else if(element["insert"]["answerImage"]!=null){result="\\embed{reply"+count_answer["value"]+","+answer_List[AnswerImage.nameFromObject(element["insert"]["answerImage"])].length+"}";count_answer["value"]++}else if(element["insert"]["image"]!=null){result='<img src="'+element["insert"]["image"]+'">'}else if(element["attributes"]!=null){if(element["attributes"]["LatexImage"]!=null){result="\\("+result+"\\)"}for(var key in element["attributes"]){switch(key){case"bold":result="<strong>"+result+"</strong>";break;case"italic":result="<em>"+result+"</em>";break;case"underline":result="<u>"+result+"</u>";break;case"strike":result="<s>"+result+"</s>";break;case"script":if(element["attributes"]["script"]=="sub"){result="<sub>"+result+"</sub>"}else if(element["attributes"]["script"]=="super"){result="<sup>"+result+"</sup>"}break;case"link":var lien=element["attributes"]["link"];result='<a href="'+lien+'">'+result+"</a>";break;case"indent":var maClass=element["attributes"]["indent"];result='<span class="wims_indent_'+maClass+'">'+result+"</span>";break;case"size":if(element["attributes"]["size"]=="small"){result='<span style="font-size:0.75em;">'+result+"</span>"}else if(element["attributes"]["size"]=="large"){result='<span style="font-size:1.25em;">'+result+"</span>"}else if(element["attributes"]["size"]=="huge"){result='<span style="font-size:1.5em;">'+result+"</span>"}break}}}if(was_variable&&result.length>0&&this.isAlphaNumeric(result[0])){result=" "+result}return result};SEditor.prototype.isAlphaNumeric=function(str){var code,i,len;for(i=0,len=str.length;i<len;i++){code=str.charCodeAt(i);if(!(code>47&&code<58)&&!(code>64&&code<91)&&!(code>96&&code<123)){return false}}return true};SEditor.prototype.applied_attributes=function(line,element,was_list){var attributes=element["attributes"];var style="";if(attributes==undefined){attributes={}}var result=line;if(Object.keys(attributes).length==0){result="<p>"+result+"</p>\n"}for(var key in attributes){switch(key){case"list":if(attributes["list"]=="bullet"){if(was_list["unordered"]==false){result="<ul><li>"+result+"</li>\n";was_list["unordered"]=true}else{result="<li>"+result+"</li>\n"}}if(attributes["list"]=="ordered"){if(was_list["ordered"]==false){result="<ol><li>"+result+"</li>\n";was_list["ordered"]=true}else{result="<li>"+result+"</li>\n"}}break;case"code-block":result+="\n";break;case"header":var bal="h"+attributes["header"];result="<"+bal+">"+result+"</"+bal+">";break;case"align":switch(attributes["align"]){case"right":style+="text-align:right;";break;case"left":style+="text-align:left;";break;case"center":style+="text-align:center;";break;case"justify":style+="text-align:justify;";break}break}}if(attributes["list"]==null){if(was_list["ordered"]){result="</ol>\n"+result;was_list["ordered"]=false}if(was_list["unordered"]){result="</ul>\n"+result;was_list["unordered"]=false}}else if(attributes["list"]=="bullet"){if(was_list["ordered"]){result="</ol>"+result;was_list["ordered"]=false}}else if(attributes["list"]=="ordered"){if(was_list["unordered"]){result="</ul>"+result;was_list["unordered"]=false}}if(style!=""){result='<p style="'+style+'">'+result+"</p>\n"}return{line:result,was_list:was_list}};SEditor.prototype.find_balise_block=function(str){var result=[];var start_balise=str.search("<");var end_balise;var name_balise="";var counter=0;result.push(start_balise);while(str[start_balise]=="<"){end_balise=str.search(">");name_balise=str.substring(start_balise+1,end_balise);counter+=name_balise.length+2;str=str.substring(end_balise+1);start_balise=0}result.push(result[0]+counter);return result};SEditor.prototype.clean_balise_block=function(str){var result="";if(str.length>0){var start_balise=0;var end_balise=str.search(">");var name_balise="";var name_complement="";var pos_complement;while(str.length>0){end_balise=str.search(">");name_balise=str.substring(start_balise+1,end_balise);if(name_balise.substring(0,3)!="img"){if(name_balise[0]=="/"){name_complement=name_balise.substring(1)}else{name_complement="/"+name_balise}pos_complement=str.search("<"+name_complement+">");if(pos_complement==-1){result+="<"+name_balise+">";str=str.substring(end_balise+1)}else{str=str.substring(name_balise.length+2,pos_complement)+str.substring(pos_complement+name_complement.length+2)}}else{result+="<"+name_balise+">";str=str.substring(end_balise+1)}}}return result};SEditor.prototype.clean_OEFcode=function(str){var tab=this.find_balise_block(str);var result="";var balise_block="";while(tab[0]!=tab[1]){balise_block=this.clean_balise_block(str.substring(tab[0],tab[1]));result+=str.substring(0,tab[0])+balise_block;str=str.substring(tab[1]);tab=this.find_balise_block(str)}result+=str;return result};return SEditor}();var Variable=function(){function Variable(name,type){this.name=name;this.type=type}Variable.prototype.init=function(){if(!this.mTypeDeclarationBlock){this.mTypeDeclarationBlock=prepEditor.mBlocklyWorkspace.newBlock("wims_change_type");this.mTypeDeclarationBlock.setFieldValue(this.name,"VARIABLE_CHOICE");this.mTypeDeclarationBlock.setDeletable(false);this.mTypeDeclarationBlock.setMovable(false);this.mTypeDeclarationBlock.initSvg();this.mTypeDeclarationBlock.render();var declarationBlocks=prepEditor.mDeclarationBlock.getChildren();if(declarationBlocks.length==0){var parentConnection=prepEditor.mDeclarationBlock.inputList[1].connection}else{var previousBlock=declarationBlocks[0];while(previousBlock.getNextBlock()){previousBlock=previousBlock.getNextBlock()}var parentConnection=previousBlock.nextConnection}var childConnection=this.mTypeDeclarationBlock.previousConnection;parentConnection.connect(childConnection);var varTypeChanged=this;var typeDeclarationBlock=this.mTypeDeclarationBlock;this.mTypeDeclarationBlock.setOnChange(function(changeEvent){varTypeChanged.type=typeDeclarationBlock.getFieldValue("TYPE")})}};Variable.prototype.getName=function(){return this.name};Variable.prototype.getType=function(){return this.type};Variable.prototype.getTypeDeclarationBlock=function(){return this.mTypeDeclarationBlock};Variable.prototype.setType=function(type){this.type=type;if(this.mTypeDeclarationBlock)this.setTypeInDeclaration()};Variable.prototype.setTypeInDeclaration=function(){this.mTypeDeclarationBlock.getField("TYPE").setValue(this.type)};Variable.prototype.getValue=function(){return this.value};Variable.prototype.setValue=function(val){this.value=val};Variable.prototype.setName=function(name){this.name=name};Variable.prototype.toString=function(){return"Variable "+this.name+" of type "+this.type};return Variable}();$(document).ready();$(document).foundation();var variable_List={};var answer_List={};var active_editor_analyse=null;var prepEditor;var analyseEditor;$("#RId_Onglet_Entete").html(Blockly.Msg.WIMS_INTERFACE_TAB_HEADER);$("#RId_Onglet_Enonce").html(Blockly.Msg.WIMS_INTERFACE_TAB_STATEMENT);$("#RId_Onglet_Preparation").html(Blockly.Msg.WIMS_INTERFACE_TAB_PREPARATION);$("#RId_Onglet_Analyse").html(Blockly.Msg.WIMS_INTERFACE_TAB_ANALYSIS);$("#RId_Onglet_Code").html(Blockly.Msg.WIMS_INTERFACE_TAB_CODE);$("#RId_Onglet_Sauvegarde").html(Blockly.Msg.WIMS_INTERFACE_TAB_SAVING);$("#Rid_Entete_Label_Title").html(Blockly.Msg.WIMS_INTERFACE_HEADER_TITLE);$("#Rid_Entete_Label_Language").html(Blockly.Msg.WIMS_INTERFACE_HEADER_LANGUAGE);$("#Rid_Entete_Label_Name").html(Blockly.Msg.WIMS_INTERFACE_HEADER_NAME);$("#Rid_Entete_Label_FirstName").html(Blockly.Msg.WIMS_INTERFACE_HEADER_FIRSTNAME);$("#Rid_Entete_Label_Email").html(Blockly.Msg.WIMS_INTERFACE_HEADER_EMAIL);$("#Rid_Entete_Label_EOFCode").html(Blockly.Msg.WIMS_INTERFACE_HEADER_OEF_CODE);$("#title_EnTete").attr("placeholder",Blockly.Msg.WIMS_INTERFACE_HEADER_TITLE_PLACEHOLDER);$("#language_EnTete").attr("placeholder",Blockly.Msg.WIMS_INTERFACE_HEADER_LANGUAGE_PLACEHOLDER);$("#name_EnTete").attr("placeholder",Blockly.Msg.WIMS_INTERFACE_HEADER_NAME_PLACEHOLDER_PLACEHOLDER);$("#firstName_EnTete").attr("placeholder",Blockly.Msg.WIMS_INTERFACE_HEADER_FIRSTNAME_PLACEHOLDER);$("#email_EnTete").attr("placeholder",Blockly.Msg.WIMS_INTERFACE_HEADER_EMAIL_PLACEHOLDER);$("#variable_creation_button").html(Blockly.Msg.WIMS_INTERFACE_BUTTON_VAR_CREATION);$("#answer_creation_button").html(Blockly.Msg.WIMS_INTERFACE_BUTTON_ANSWER_CREATION);$("#Rid_Analysis_Header_VarAnswers").html(Blockly.Msg.WIMS_INTERFACE_ANALYSIS_VARIABLES_AND_ANSWERS);$("#Rid_Prep_Blockly_Toolbar_WIMS").attr("name",Blockly.Msg.WIMS_BLOCKLY_PREP_WIMS);$("#Rid_Prep_Blockly_Toolbar_Variables").attr("name",Blockly.Msg.WIMS_BLOCKLY_PREP_VARIABLES);$("#Rid_Prep_Blockly_Toolbar_Swarms").attr("name",Blockly.Msg.WIMS_BLOCKLY_PREP_SWARMS);$("#Rid_Analysis_Blockly_Toolbar_Analysis").attr("name",Blockly.Msg.WIMS_BLOCKLY_ANALYSIS_ANALYSIS);$("#Rid_Analysis_Blockly_Toolbar_Variables").attr("name",Blockly.Msg.WIMS_BLOCKLY_ANALYSIS_VARIABLES);function change_onglet(name){$("#RId_Onglet_"+anc_onglet).removeClass("RCl_Onglet_Affiche").addClass("RCl_Onglet_Cache");$("#RId_Onglet_"+name).removeClass("RCl_Onglet_Cache").addClass("RCl_Onglet_Affiche");$("#RId_Contenu_Onglet_"+anc_onglet).addClass("RCl_Contenu_Onglet_Cache");$("#RId_Contenu_Onglet_"+name).removeClass("RCl_Contenu_Onglet_Cache");anc_onglet=name;if(typeof prepEditor!="undefined"){prepEditor.onResize();Blockly.svgResize(prepEditor.mBlocklyWorkspace);prepEditor.mBlocklyWorkspace.scrollX=27}if(typeof analyseEditor!="undefined"){analyseEditor.onResize();Blockly.svgResize(analyseEditor.mBlocklyWorkspace);analyseEditor.mBlocklyWorkspace.scrollX=27}}var quill=new Quill("#editor-enonce",{modules:{formula:true,toolbar:"#toolbar-container"},placeholder:Blockly.Msg.WIMS_STATEMENT_EDITOR_PLACEHOLDER,theme:"snow"});var quill_EnTete=new Quill("#editor-EnTete",{modules:{toolbar:false},placeholder:Blockly.Msg.WIMS_HEADER_EDITOR_PLACEHOLDER,theme:"snow"});var anc_onglet="Entete";change_onglet(anc_onglet);quill_EnTete.format("code-block",true);var editor_EnTete=new SEditor(quill_EnTete);change_onglet("Enonce");var editor_Enonce=new SEditor(quill);Blockly.Workspace.prototype.createVariable_orig=Blockly.Workspace.prototype.createVariable;Blockly.Workspace.prototype.createVariable=function(name){Blockly.Workspace.prototype.createVariable_orig.call(this,name);if(variable_List[name]==null){variable_List[name]=new Variable(name,"Real");variable_List[name].init();update_all_view()}if(this.id==prepEditor.mBlocklyWorkspace.id){analyseEditor.mBlocklyWorkspace.createVariable(name)}};Blockly.Workspace.prototype.renameVariable_orig=Blockly.Workspace.prototype.renameVariable;Blockly.Workspace.prototype.renameVariable=function(oldName,newName){Blockly.Workspace.prototype.renameVariable_orig.call(this,oldName,newName);if(!variable_List[newName]){variable_List[newName]=variable_List[oldName];variable_List[newName].setName(newName);changeAllNameVar(oldName,newName);delete variable_List[oldName];update_all_view();if(this.id==prepEditor.mBlocklyWorkspace.id){analyseEditor.mBlocklyWorkspace.renameVariable_orig.call(analyseEditor.mBlocklyWorkspace,oldName,newName)}else if(this.id==analyseEditor.mBlocklyWorkspace.id){prepEditor.mBlocklyWorkspace.renameVariable_orig.call(prepEditor.mBlocklyWorkspace,oldName,newName)}}};Blockly.Workspace.prototype.deleteVariable_orig=Blockly.Workspace.prototype.deleteVariable;Blockly.Workspace.prototype.deleteVariable=function(name){if(variable_List[name]){delete variable_List[name];editor_Enonce.destroy_var(name);for(var key in answer_List){answer_List[key].get_block_html().get_editor().destroy_var(name)}for(var i=0;i<Blockly.ExternalDiv.owner.length;i++){var tmpEditor=new SEditor(Blockly.ExternalDiv.owner[i].quillEditor_);tmpEditor.destroy_var(name)}update_all_view();Blockly.Workspace.prototype.deleteVariable_orig.call(this,name);if(this.id==prepEditor.mBlocklyWorkspace.id){analyseEditor.mBlocklyWorkspace.deleteVariable_orig.call(analyseEditor.mBlocklyWorkspace,name)}else if(this.id==analyseEditor.mBlocklyWorkspace.id){prepEditor.mBlocklyWorkspace.deleteVariable_orig.call(prepEditor.mBlocklyWorkspace,name)}}};function add_answer(editor,ans_list){editor.focus();var positionSelection=editor.getSelection();if(positionSelection.length==0){var name=window.prompt(Blockly.Msg.WIMS_PROMPT_ANSWER_NAME,Blockly.Msg.WIMS_PROMPT_ANSWER_NAME_PLACEHOLDER);if(name!=null&&test_valid_expression(name)&&ans_list[name]==null){ans_list[name]=new Answer(name,"numeric");ans_list[name].get_block_html().create_editor();ans_list[name].get_block_html().get_editor().editor.on("editor-change",function(){if(active_editor_analyse!=null||active_editor_analyse!=ans_list[name].get_block_html().get_editor()){active_editor_analyse=ans_list[name].get_block_html().get_editor()}});insert_embed_object(editor,positionSelection.index,"answerImage",name,editor.container.id)}else{window.alert(Blockly.Msg.WIMS_PROMPT_ANSWER_NAME_ERROR)}}}function test_valid_expression(str){var patt=/^[a-zA-Z][a-zA-Z0-9_]*$/;return patt.test(str)}function insert_embed_object(editor,index,type,value,variable1,variable2,variable3){var transferVar;if(typeof variable1=="undefined"&&typeof variable2=="undefined"&&typeof variable3=="undefined"){transferVar=value}else{transferVar=JSON.stringify({value:value,variable1:variable1,variable2:variable2,variable3:variable3})}editor.insertEmbed(index,type,transferVar)}function create_variable_editor(id_select_type_popup,id_input_name_popup,index){var type=document.getElementById(id_select_type_popup).options[document.getElementById(id_select_type_popup).selectedIndex].value;var name=document.getElementById(id_input_name_popup).value;if(test_valid_expression(name)){insert_embed_object(quill,index,"VariableImage",name);if(variable_List[name]==null){variable_List[name]=new Variable(name,type);variable_List[name].init();update_variables_view("card_Enonce_Variable",variable_List);update_all_view();$("#popup").toggleClass("popup_variable_visible");add_blockly_variable(name)}}else{window.alert(Blockly.Msg.WIMS_PROMPT_VARIABLE_NAME_ERROR)}}function change_to_var(editor,var_list){editor.focus();var positionSelection=editor.getSelection();if(positionSelection.length==0){create_variable_choice_popup("variable_creation_button",positionSelection.index)}else{var nameVar=editor.getText(positionSelection.index,positionSelection.length);if(test_valid_expression(nameVar)){editor.deleteText(positionSelection.index,positionSelection.length);insert_embed_object(editor,positionSelection.index,"VariableImage",nameVar);if(var_list[nameVar]==null){var_list[nameVar]=new Variable(nameVar,"real");var_list[nameVar].init();update_variables_view("card_Enonce_Variable",var_list);update_all_view();add_blockly_variable(nameVar)}}else{window.alert(Blockly.Msg.WIMS_PROMPT_VARIABLE_NAME_ERROR)}}}function change_type_answer(id_answer,type,ans_list){ans_list[id_answer].get_block_html().change_to_type(type);ans_list[id_answer].type=type}function delete_element_answer_list(name){answer_List[name].get_block_html().destroy();delete answer_List[name]}function update_analyse_answer(editor,ans_list){var tab_answer=editor.get_answer_tab();var pos;for(var key in ans_list){pos=tab_answer.indexOf(key);if(pos!=-1){if(pos>0){$("#answer_list_analyse .callout").eq(pos-1).after($("#answer_all_"+key))}else{$("#answer_list_analyse .callout").eq(0).before($("#answer_all_"+key))}}else{delete_element_answer_list(key)}}}function get_active_editor_analyse(){var result=null;for(var key in answer_List){if(answer_List[key].get_block_html().get_editor().editor.hasFocus()){result=answer_List[key].get_block_html().get_editor()}}return result}function destroy_answer(name){delete_element_answer_list(name);editor_Enonce.destroy_answer(name);for(var key in answer_List){answer_List[key].get_block_html().get_editor().destroy_answer(name)}}function create_list_variables(variable_list){var result="";for(var key in variable_list){result+='<li style="margin-bottom:5px;position:relative;"><span class="surligne_Variable" onclick="editor_Enonce.add_variable(\''+key+"');\">"+key+'</span><button id="button_destroy_'+key+'" class="close-button" aria-label="Close alert" type="button" style="float:right;clear:right;font-size:1.6em;top:0px;" onclick="destroy_variable(\''+key+'\');update_all_view();"><span aria-hidden="true">&times;</span></button></li>'}return result}function create_list_variables_analyse(variable_list){var result="";for(var key in variable_list){result+='<li style="margin-bottom:5px;position:relative;"><span class="surligne_Variable" onclick="active_editor_analyse.add_variable(\''+key+"');\">"+key+'</span><button id="button_destroy_'+key+'" class="close-button" aria-label="Close alert" type="button" style="float:right;clear:right;font-size:1.6em;top:0px;" onclick="destroy_variable(\''+key+'\');update_all_view();"><span aria-hidden="true">&times;</span></button></li>'}return result}function create_list_answer(answer_tab){var result="";for(var key in answer_tab){result+='<li style="margin-bottom:5px;position:relative;"><span class="surligne_Answer" onclick="active_editor_analyse.add_answer(\''+key+"');\">"+key+'</span><button id="button_destroy_'+key+'" class="close-button" aria-label="Close alert" type="button" style="float:right;clear:right;font-size:1.6em;top:0px;" onclick="destroy_answer(\''+key+'\');update_all_view();"><span aria-hidden="true">&times;</span></button></li>'}return result}function create_list_var_prep(variable_list){var result="";for(var key in variable_list){result+='<li style="margin-bottom:5px;position:relative;"><span class="surligne_Variable" onclick="add_variable_editor_blockly(\''+key+"');\">"+key+'</span><button id="button_destroy_'+key+'" class="close-button" aria-label="Close alert" type="button" style="float:right;clear:right;font-size:1.6em;top:0px;" onclick="destroy_variable(\''+key+'\');update_all_view();"><span aria-hidden="true">&times;</span></button></li>'}return result}function update_variables_view(id_to_updt,variable_list){var result="";result="<ul class='variable_List_Enonce'>"+create_list_variables(variable_list)+"</ul>";document.getElementById(id_to_updt).innerHTML=result}function update_variables_prep_view(variable_list){var result="";result="<ul class='variable_List_Enonce'>"+create_list_var_prep(variable_list)+"</ul>";document.getElementById("card_Prep_Variable").innerHTML=result}function update_variables_answers_view(id_to_updt,variable_list,answer_tab){var result="";result="<ul class='variable_List_Enonce'>"+create_list_variables_analyse(variable_list)+create_list_answer(answer_tab)+"</ul>";document.getElementById(id_to_updt).innerHTML=result}function update_all_view(){update_variables_view("card_Enonce_Variable",variable_List);update_variables_prep_view(variable_List);update_variables_answers_view("card_Analyse_Variable",variable_List,answer_List)}function gather_all_info(){var all_info={};all_info["title"]=document.getElementById("title_EnTete").value;all_info["language"]=document.getElementById("language_EnTete").value;all_info["name"]=document.getElementById("name_EnTete").value;all_info["firstName"]=document.getElementById("firstName_EnTete").value;all_info["email"]=document.getElementById("email_EnTete").value;all_info["OEF_code"]=editor_EnTete.to_OEFcode();all_info["enonce"]=editor_Enonce.to_OEFcode();return all_info}function create_variable_choice_popup(id_to_popup,index){var rect=document.getElementById(id_to_popup).getBoundingClientRect();$("#popup").toggleClass("popup_variable_visible");$("#popup").addClass("large-3");$("#popup").addClass("columns");$("#popup").css({top:rect.top+(rect.bottom-rect.top)/2,left:rect.left+(rect.right-rect.left)/1.3,position:"absolute"});document.getElementById("popup").innerHTML='<div class="callout"><label>Variable type'+'<select id = "popup_select">'+'<option value="Real">Real</option>'+'<option value="Draw">Draw</option>'+'<option value="Fun">Function</option>'+'<option value="Int">Integer</option>'+"</select>"+"</label>"+'<input placeholder="'+Blockly.Msg.WIMS_POPUP_VARIABLE_NAME_PLACEHOLDER+'" type="text" id="popup_input"></input>'+'<a href="#" class="button" onclick="create_variable_editor(\'popup_select\',\'popup_input\','+index+')">'+Blockly.Msg.WIMS_POPUP_VARIABLE_BUTTON_CREATE+"</a>"+"</div>"}function destroy_variable(name){delete_blockly_variable(name);delete variable_List[name];editor_Enonce.destroy_var(name);for(var key in answer_List){answer_List[key].get_block_html().get_editor().destroy_var(name)}for(var i=0;i<Blockly.ExternalDiv.owner.length;i++){var tmpEditor=new SEditor(Blockly.ExternalDiv.owner[i].quillEditor_);tmpEditor.destroy_var(name)}}function create_answer_OEF(answer){var result="\\answer{}";result+="{"+answer.to_OEF()+"}";result+="{type="+answer.get_type()+"}";result+=answer.get_option();return result}function get_all_answer_OEF(){var result="";for(var i=0;i<Object.keys(answer_List).length;i++){result+=create_answer_OEF(answer_List[$("#answer_list_analyse .callout").get(i).id.substring(11)])+"\n"}return result}function update_final_code(){var result="";var infos=gather_all_info();if(infos.title==""){result+="\\title{Exercice}\n"}else{result+="\\title{"+infos.title+"}\n"}result+="\\language{"+infos.language+"}\n";if(infos.firstName==""&&infos.name==""){result+="\\author{}\n"}else{result+="\\author{"+infos.firstName+","+infos.name+"}\n"}result+="\\email{"+infos.email+"}\n";result+="\\computeanswer{no}\n";result+="\\format{html}\n";result+="\\precision{1000}\n";result+="\\range{-5..5}";result+="\n";result+=infos.OEF_code;result+="\n";result+=generate_prep_code()+"\n";result+="\\statement{\n";result+=infos.enonce;result+="}\n";result+=get_all_answer_OEF()+"\n";result+=generate_analyse_code();document.getElementById("final_OEF_code").value=result}function add_blockly_variable(name){prepEditor.mBlocklyWorkspace.createVariable(name);analyseEditor.mBlocklyWorkspace.createVariable(name)}function delete_blockly_variable(name){prepEditor.mBlocklyWorkspace.deleteVariable_orig.call(prepEditor.mBlocklyWorkspace,name);analyseEditor.mBlocklyWorkspace.deleteVariable_orig.call(analyseEditor.mBlocklyWorkspace,name)}function add_variable_editor_blockly(name){var monDiv=Blockly.ExternalDiv.activeDivId;var index=-1;if(monDiv){for(var i=0;i<Blockly.ExternalDiv.DIV.length;i++){if(Blockly.ExternalDiv.DIV[i].id==monDiv){index=i}}var tmp=new SEditor(Blockly.ExternalDiv.owner[index].quillEditor_);tmp.add_variable(name)}}function add_answer_editor_blockly(name){var monDiv=Blockly.ExternalDiv.activeDivId;var index=-1;if(monDiv){for(var i=0;i<Blockly.ExternalDiv.DIV.length;i++){if(Blockly.ExternalDiv.DIV[i].id==monDiv){index=i}}var tmp=new SEditor(Blockly.ExternalDiv.owner[index].quillEditor_);tmp.add_answer(name)}}function generate_prep_code(){Blockly.OEF.addReservedWords("code");var code=Blockly.OEF.workspaceToCode(prepEditor.mBlocklyWorkspace);return code}function generate_analyse_code(){Blockly.OEF.addReservedWords("code");var code=Blockly.OEF.workspaceToCode(analyseEditor.mBlocklyWorkspace);return code}function generate_list_var_popup(){var result='<ul style="margin-left:5px;">';for(var key in variable_List){result+='<li style="margin-bottom:5px;position:relative;list-style: none;">'+'<span class="surligne_Variable" style="font-size:0.7em;" onclick="add_variable_editor_blockly(\''+key+"');\">"+key+"</span>"+"</li>"}result+="</ul>";return result}function generate_list_var_answer_popup(){var result='<ul style="margin-left:5px;">';for(var key in variable_List){result+='<li style="margin-bottom:5px;position:relative;list-style: none;">'+'<span class="surligne_Variable" style="font-size:0.7em;" onclick="add_variable_editor_blockly(\''+key+"');\">"+key+"</span>"+"</li>"}for(var key in answer_List){result+='<li style="margin-bottom:5px;position:relative;list-style: none;">'+'<span class="surligne_Answer" style="font-size:0.7em;" onclick="add_answer_editor_blockly(\''+key+"');\">"+key+"</span>"+"</li>"}result+="</ul>";return result}function changeAllNameVar(oldName,newName){editor_Enonce.changeNameVar(oldName,newName);editor_EnTete.changeNameVar(oldName,newName);for(var key in answer_List){answer_List[key].get_block_html().get_editor().changeNameVar(oldName,newName)}for(var i=0;i<Blockly.ExternalDiv.owner.length;i++){var tmpEditor=new SEditor(Blockly.ExternalDiv.owner[i].quillEditor_);tmpEditor.changeNameVar(oldName,newName)}}function generate_popup_list_var(x,y,withAnswer){var maDiv=document.createElement("div");maDiv.id="popup_var_blockly";if(!withAnswer){maDiv.innerHTML=generate_list_var_popup()}else{maDiv.innerHTML=generate_list_var_answer_popup()}maDiv.style.top=y+"px";maDiv.style.left=x+"px";maDiv.style.height="100px";maDiv.style.padding="1px 10px 1px 1px";maDiv.style.position="absolute";maDiv.style.overflow="scroll";maDiv.style.backgroundColor="grey";if(Object.keys(variable_List).length==0&&Object.keys(answer_List).length==0){maDiv.style.visibility="hidden"}document.body.appendChild(maDiv)}function get_variables_JSON(){var entete=gather_all_info();delete entete["enonce"];delete entete["OEF_code"];var state={enonce:editor_Enonce,variables:variable_List,answer:answer_List,prep:Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(prepEditor.mBlocklyWorkspace)),analyse:Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(analyseEditor.mBlocklyWorkspace)),en_tete:entete,editor_EnTete:editor_EnTete};function fun2(key,value){if(key!="editor"&&key!="all_type"&&key!="html"&&key!="mTypeDeclarationBlock"){return value}if(key=="editor"){return value.getContents()}}document.getElementById("save_state").value=JSON.stringify(state,fun2," ");return JSON.stringify(state,fun2," ")}function parse_save(save){function reviver(key,value){if(key=="editor"){return new SEditor(value)}else{return value}}var state=JSON.parse(save,reviver);variable_List={};$("#title_EnTete").get(0).value=state["en_tete"]["title"];$("#language_EnTete").get(0).value=state["en_tete"]["language"];$("#name_EnTete").get(0).value=state["en_tete"]["name"];$("#firstName_EnTete").get(0).value=state["en_tete"]["firstName"];$("#email_EnTete").get(0).value=state["en_tete"]["email"];editor_EnTete.editor.setContents(state["editor_EnTete"]["editor"].editor);editor_Enonce.editor.setContents(state["enonce"]["editor"].editor);prepEditor.load(state["prep"]);analyseEditor.load(state["analyse"]);var ans_list_tmp={};var res={};for(var key in state["variables"]){if(variable_List[key]){variable_List[key].setType(state["variables"][key]["type"])}else{variable_List[key]=new Variable(state["variables"][key]["name"],state["variables"][key]["type"]);variable_List[key].init()}}for(var key in variable_List){variable_List[key].setTypeInDeclaration()}$("#answer_list_analyse").html("");for(var key in state["answer"]){ans_list_tmp[key]=new Answer(state["answer"][key]["name"],state["answer"][key]["type"]);ans_list_tmp[key].length=state["answer"][key]["length"];ans_list_tmp[key].get_block_html().create_editor();ans_list_tmp[key].get_block_html().editor.editor.setContents(state["answer"][key]["block_html"]["editor"].editor);ans_list_tmp[key].get_block_html().change_to_type(state["answer"][key]["type"]);if(state["answer"][key]["type"]=="other"){$("#ans_"+key+"_type textarea").val(state["answer"][key]["sub_type"])}$("#answer_all_"+key).find("select").val(state["answer"][key]["type"]);$("#answer_all_"+key+" option[value="+state["answer"][key]["type"]+"]").attr("selected","selected")}answer_List=ans_list_tmp}function editor_on_change_analysis(key){answer_List[key].get_block_html().get_editor().editor.on("editor-change",function(){if(active_editor_analyse!=null||active_editor_analyse!=answer_List[key].get_block_html().get_editor()){active_editor_analyse=answer_List[key].get_block_html().get_editor()}})}function use_save_state(){parse_save(document.getElementById("save_state").value)}function get_editor_field_wims(id_field_WIMS){var index=-1;for(var i=0;i<Blockly.ExternalDiv.DIV.length;i++){if(Blockly.ExternalDiv.DIV[i].id==id_field_WIMS){index=i}}if(index!=-1){var editorTmp=new SEditor(Blockly.ExternalDiv.owner[index].quillEditor_);return editorTmp}else{console.log("get_editor_field_wims() error, no index found");return null}}function create_popup_embed_answer(id_element,answer_name){var textHtml="Entrez la taille que vous souhaitez pour votre réponse (par défaut 10):"+'<textarea id="popup_textarea_'+answer_name+'" placeholder="length..."></textarea>'+'<a class="button tiny" onclick=\'change_length_answer_via_popup("'+answer_name+"\")'>Valider</a>";var length=document.getElementById(id_element).getBoundingClientRect();$("#popup").html(textHtml);$("#popup_textarea_"+answer_name).get(0).value=answer_List[answer_name].length;$("#popup").css("height","150px");$("#popup").css("position","fixed");$("#popup").css("width","230px");$("#popup").css("font-size","0.7em");$("#popup").css("z-index","9000");$("#popup").css("background-color","white");$("#popup").addClass("callout");$("#popup").css("top",length.top+20+"px");$("#popup").css("left",length.left-5+"px");$("#popup").toggleClass("popup_variable_visible")}function generate_unique_id_answer(name){var valid_id=false;var tmpId="";var i=1;while(!valid_id){tmpId=name+i;if(document.getElementById(tmpId)==null){valid_id=true}else{i++}}return tmpId}function change_length_answer_via_popup(answer_name){var length=$("#popup_textarea_"+answer_name).get(0).value;answer_List[answer_name].length=length;$("#popup").toggleClass("popup_variable_visible")}function hide_popup(){Blockly.ExternalDiv.hide();$("#popup").removeClass("popup_variable_visible")}function register_type_other(){for(var key in answer_List){if($("#answer_all_"+key+" select").val()=="other"){answer_List[key].type="other";answer_List[key].set_sub_type(answer_List[key].get_type())}}}Blockly.Blocks["wims_start"]={init:function(){this.appendDummyInput().appendField(new Blockly.FieldLabel("","editor_title_block"),"START_TEXT");this.setNextStatement(true,null);this.setColour(180);this.setTooltip("");this.setHelpUrl("")}};Blockly.Blocks["wims_declaration"]={init:function(){this.appendDummyInput().appendField(new Blockly.FieldLabel(""),"DECLARATION_TEXT");this.appendStatementInput("DECLARATION").setCheck(null);this.setPreviousStatement(true,null);this.setNextStatement(true,null);this.setColour(180);this.setTooltip("");this.setHelpUrl("")}};Blockly.Blocks["wims_while"]={init:function(){this.appendDummyInput().appendField(Blockly.Msg.WIMS_WHILE).appendField(new Blockly.FieldTextInput("true"),"WIMS_EDITOR");this.appendStatementInput("WHILE").setCheck(null).appendField("Do");this.setPreviousStatement(true,null);this.setNextStatement(true,null);this.setColour(300);this.setTooltip("");this.setHelpUrl("")}};Blockly.Blocks["wims_change_type"]={init:function(){this.appendDummyInput().appendField(new Blockly.FieldVariable(""),"VARIABLE_CHOICE").appendField(Blockly.Msg.WIMS_IS_TYPE).appendField(new Blockly.FieldDropdown([[Blockly.Msg.WIMS_REAL_NUMBER,"real"],[Blockly.Msg.WIMS_INTEGER_NUMBER,"integer"],[Blockly.Msg.WIMS_RATIONAL_NUMBER,"rational"],[Blockly.Msg.WIMS_MATRIX,"matrix"],[Blockly.Msg.WIMS_TEXT,"text"],[Blockly.Msg.WIMS_FUNCTION,"function"],[Blockly.Msg.WIMS_COMPLEX_NUMBER,"complex"]]),"TYPE");this.setPreviousStatement(true,null);this.setNextStatement(true,null);this.setColour(180);this.setTooltip("");this.setHelpUrl("")}};Blockly.Blocks["wims_if"]={init:function(){this.appendDummyInput().appendField(Blockly.Msg.WIMS_IF_CONDITION).appendField(new Blockly.FieldWIMSEditor("","Quill Contents In Blockly",false,false),"WIMS_EDITOR");this.appendStatementInput("DO").setCheck(null).appendField(Blockly.Msg.WIMS_IF_CONDITION_DO);this.appendDummyInput().appendField(Blockly.Msg.WIMS_IF_CONDITION_ELSE);this.appendStatementInput("ELSE").setCheck(null).appendField(Blockly.Msg.WIMS_IF_CONDITION_DO);this.setPreviousStatement(true,null);this.setNextStatement(true,null);this.setColour(230);this.setTooltip("");this.setHelpUrl("")}};Blockly.Blocks["wims_comment"]={init:function(){this.appendDummyInput().appendField("//").appendField(new Blockly.FieldTextInput(""),"COMMENT");this.setPreviousStatement(true,null);this.setNextStatement(true,null);this.setColour(230);this.setTooltip("");this.setHelpUrl("");this.getField("COMMENT").setValue("default")}};Blockly.Blocks["wims_define_variable"]={init:function(){this.appendDummyInput().appendField(new Blockly.FieldVariable(""),"VARIABLE_CHOICE").appendField(Blockly.Msg.WIMS_IS_TYPE).appendField(new Blockly.FieldDropdown([[Blockly.Msg.WIMS_REAL_NUMBER,"real"],[Blockly.Msg.WIMS_INTEGER_NUMBER,"integer"],[Blockly.Msg.WIMS_RATIONAL_NUMBER,"rational"],[Blockly.Msg.WIMS_MATRIX,"matrix"],[Blockly.Msg.WIMS_TEXT,"text"],[Blockly.Msg.WIMS_FUNCTION,"function"],[Blockly.Msg.WIMS_COMPLEX_NUMBER,"complex"]]),"TYPE");this.appendDummyInput().appendField(Blockly.Msg.WIMS_WITH_VALUE).appendField(new Blockly.FieldWIMSEditor("","testQuillInBlockly",false,false),"WIMS_EDITOR");this.setPreviousStatement(true,null);this.setNextStatement(true,null);this.setColour(100);this.setTooltip("");this.setHelpUrl("")}};Blockly.Blocks["wims_editor"]={init:function(){this.appendDummyInput().appendField(new Blockly.FieldWIMSEditor("","Quill contents in blockly",false,false),"WIMS_EDITOR");this.setOutput(true,null);this.setColour(300);this.setTooltip("");this.setHelpUrl("")}};Blockly.Blocks["wims_variable_editor"]={init:function(){this.appendDummyInput().appendField(Blockly.Msg.WIMS_VARIABLE_SET).appendField(new Blockly.FieldVariable(""),"VARIABLE_CHOICE").appendField(Blockly.Msg.WIMS_VARIABLE_TO).appendField(new Blockly.FieldWIMSEditor("","Quill contents in blockly",false,false),"WIMS_EDITOR");this.setPreviousStatement(true,null);this.setNextStatement(true,null);this.setColour(300);this.setTooltip("");this.setHelpUrl("")}};Blockly.Blocks["wims_up_down_editor"]={init:function(){this.appendDummyInput().appendField(Blockly.Msg.WIMS_OEF_CODE);this.appendDummyInput().appendField(new Blockly.FieldWIMSEditor("","Quill contents in blockly",false,false),"WIMS_EDITOR");this.setPreviousStatement(true,null);this.setNextStatement(true,null);this.setColour(270);this.setTooltip("NOTIP");this.setHelpUrl("NOHELP")}};Blockly.Blocks["wims_repeat"]={init:function(){this.appendValueInput("NUM").setCheck(null).appendField(Blockly.Msg.WIMS_LOOP_REPEAT);this.appendDummyInput().appendField(Blockly.Msg.WIMS_LOOP_TIMES);this.appendStatementInput("DO").setCheck(null).appendField("do");this.setInputsInline(true);this.setPreviousStatement(true,null);this.setNextStatement(true,null);this.setColour(230);this.setTooltip("");this.setHelpUrl("")}};Blockly.Blocks["wims_for"]={init:function(){this.appendDummyInput().appendField(Blockly.Msg.WIMS_LOOP_FOR).appendField(new Blockly.FieldVariable(""),"VARIABLE_CHOICE");this.appendValueInput("START").setCheck(null).appendField(Blockly.Msg.WIMS_LOOP_FROM);this.appendValueInput("END").setCheck(null).appendField(Blockly.Msg.WIMS_LOOP_TO);this.appendValueInput("STEP").setCheck(null).appendField(Blockly.Msg.WIMS_LOOP_STEP);this.appendStatementInput("DO").setCheck(null).appendField(Blockly.Msg.WIMS_LOOP_DO);this.setInputsInline(true);this.setPreviousStatement(true,null);this.setNextStatement(true,null);this.setColour(230);this.setTooltip("");this.setHelpUrl("")}};Blockly.Blocks["analyse_feedback"]={init:function(){this.appendDummyInput().appendField(Blockly.Msg.WIMS_FEEDBACK);this.appendDummyInput().appendField(Blockly.Msg.WIMS_FEEDBACK_IF).appendField(new Blockly.FieldWIMSEditor("","Quill contents in blockly",false,true),"WIMS_EDITOR_TEST");this.appendDummyInput().appendField(Blockly.Msg.WIMS_FEEDBACK_SEND).appendField(new Blockly.FieldWIMSEditor("","Quill contents in blockly",true,true),"WIMS_EDITOR");this.setPreviousStatement(true,null);this.setNextStatement(true,null);this.setColour(230);this.setTooltip("");this.setHelpUrl("")}};Blockly.Blocks["analyse_hint"]={init:function(){this.appendDummyInput().appendField(Blockly.Msg.WIMS_HINT);this.appendDummyInput().appendField(new Blockly.FieldWIMSEditor("","Quill contents in blockly",true,true),"WIMS_EDITOR");this.setPreviousStatement(true,null);this.setNextStatement(true,null);this.setColour(230);this.setTooltip("");this.setHelpUrl("")}};Blockly.Variables.flyoutCategory=function(workspace){var variableList=workspace.variableList;variableList.sort(goog.string.caseInsensitiveCompare);var xmlList=[];var button=goog.dom.createDom("button");button.setAttribute("text",Blockly.Msg.NEW_VARIABLE);button.setAttribute("callbackKey","CREATE_VARIABLE");workspace.registerButtonCallback("CREATE_VARIABLE",function(button){Blockly.Variables.createVariable(button.getTargetWorkspace())});xmlList.push(button);if(variableList.length>0){for(var i=0;i<variableList.length;i++){if(Blockly.Blocks["variables_get"]){var blockText="<xml>"+'<block type="variables_get" gap="8">'+'<field name="VAR">'+variableList[i]+"</field>"+"</block>"+"</xml>";var block=Blockly.Xml.textToDom(blockText).firstChild;xmlList.push(block)}}}return xmlList};"use strict";goog.provide("Blockly.FieldWIMSEditor");goog.require("Blockly.Field");goog.require("goog.dom");goog.require("goog.math.Size");goog.require("goog.userAgent");Blockly.FieldWIMSEditor=function(content,opt_alt,toolbar,isAnalyze){Blockly.FieldWIMSEditor.superClass_.constructor.call(this,content,null);this.sourceBlock_=null;this.editorDivId_=null;this.quillEditor_=null;this.toolbar=toolbar;this.isAnalyze=isAnalyze;this.content_=content;this.value;this.size_=new goog.math.Size(0,0);this.text_=opt_alt||""};goog.inherits(Blockly.FieldWIMSEditor,Blockly.Field);Blockly.FieldWIMSEditor.prototype.EDITABLE=true;Blockly.FieldWIMSEditor.UNIQUE_QUILL_ID=0;Blockly.FieldWIMSEditor.prototype.init=function(){if(this.editorDivId_){return}if(this.fieldGroup_){return}Blockly.FieldWIMSEditor.superClass_.init.call(this);var editorDiv=document.createElement("div");editorDiv.style.position="absolute";Blockly.FieldWIMSEditor.UNIQUE_QUILL_ID++;this.editorDivId_="Blockly_quill_"+Blockly.FieldWIMSEditor.UNIQUE_QUILL_ID;editorDiv.id=this.editorDivId_;if(this.toolbar){editorDiv.innerHTML=create_div_quill_toolbar(this.editorDivId_)}document.body.appendChild(editorDiv);editorDiv.style.width="200px";editorDiv.style.height="40px";if(this.toolbar){editorDiv.style.width="400px";editorDiv.style.height="150px";editorDiv.style.backgroundColor="white"}Blockly.ExternalDiv.register(editorDiv,this);this.setSize_(editorDiv.offsetWidth,editorDiv.offsetHeight);if(!this.quillEditor_){if(!this.toolbar){this.quillEditor_=new Quill("#"+this.editorDivId_,{modules:{toolbar:false},placeholder:Blockly.Msg.WIMS_EDITOR_PLACEHOLDER,theme:"snow"});this.quillEditor_.insertText(0,"");this.editorSEditor=new SEditor(this.quillEditor_)}else{this.quillEditor_=new Quill("#"+this.editorDivId_+"_quill",{modules:{toolbar:"#"+this.editorDivId_+"_toolbar"},placeholder:Blockly.Msg.WIMS_EDITOR_PLACEHOLDER,theme:"snow"});this.quillEditor_.insertText(0,"");this.editorSEditor=new SEditor(this.quillEditor_)}}if(this.value){this.quillEditor_.setContents(this.value)}this.placeholderImageElement_=Blockly.utils.createSvgElement("image",{},this.fieldGroup_);this.placeholderImageElement_.setAttributeNS(null,"width",this.width_+"px");this.placeholderImageElement_.setAttributeNS(null,"height",this.height_+"px");this.computePlaceholderImage_();this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_)};Blockly.FieldWIMSEditor.prototype.computePlaceholderImage_=function(){if(this.placeholderImageElement_&&this.editorDivId_){var fieldTmp={x:this};var editorDiv=document.getElementById(this.editorDivId_);html2canvas(editorDiv).then(function(canvas){var canvas_url=canvas.toDataURL();var width=fieldTmp.x.width_;var height=fieldTmp.x.height_;var XLink_NS="http://www.w3.org/1999/xlink";fieldTmp.x.placeholderImageElement_.setAttributeNS(XLink_NS,"xlink:href",canvas_url)},function(err){console.log("html2canvas error:"+err)})}};Blockly.FieldWIMSEditor.prototype.setSize_=function(width,height){this.width_=width;this.height_=height;this.size_=new goog.math.Size(this.width_,this.height_+2*Blockly.BlockSvg.INLINE_PADDING_Y);var editorDiv=document.getElementById(this.editorDivId_);editorDiv.setAttribute("width",width+"px");editorDiv.setAttribute("height",height+"px")};Blockly.FieldWIMSEditor.prototype.dispose=function(){goog.dom.removeNode(this.fieldGroup_);this.fieldGroup_=null;Blockly.ExternalDiv.dispose(this.editorDivId_);this.quillEditor_=null;this.placeholderImageElement_=null};Blockly.FieldWIMSEditor.prototype.setValue=function(content){if(content===null){return}this.content_=content;if(!this.sourceBlock_){return}if(!this.quillEditor_){return}this.quillEditor_.setContents(content)};Blockly.FieldWIMSEditor.prototype.setText=function(alt){if(alt===null){return}this.text_=alt};function create_div_quill_toolbar(id){var toolbar="<div id='"+id+"_toolbar'>"+'<span class="ql-formats">'+'<button class="ql-bold"></button>'+'<button class="ql-italic"></button>'+'<button class="ql-underline"></button>'+'<button class="ql-strike"></button>'+"</span>"+'<span class="ql-formats">'+'<button style="margin-right:8px;" title="latex" onclick="get_editor_field_wims(\''+id+"').change_to_latex()\">LaTeX</button>"+"</span>"+"</div>";var quill="<div id='"+id+"_quill'></div>";return toolbar+quill}Blockly.FieldWIMSEditor.prototype.showEditor_=function(opt_quietInput){this.workspace_=this.sourceBlock_.workspace;var quietInput=opt_quietInput||false;if(!quietInput&&(goog.userAgent.MOBILE||goog.userAgent.ANDROID||goog.userAgent.IPAD)){var fieldText=this;Blockly.prompt(Blockly.Msg.CHANGE_VALUE_TITLE,this.text_,function(newValue){fieldText.setValue(newValue)});return}Blockly.ExternalDiv.show(this.editorDivId_);var bBox=this.fieldGroup_.getBBox();var editorDiv=document.getElementById(this.editorDivId_);var xy=this.getAbsoluteXY_();if(this.sourceBlock_.RTL){var borderBBox=this.getScaledBBox_();xy.x+=borderBBox.width;xy.x-=div.offsetWidth}xy.y+=1;if(goog.userAgent.GECKO&&editorDiv.style.top){xy.x+=5;xy.y-=1}if(goog.userAgent.WEBKIT&&editorDiv.style.top){xy.x+=4;xy.y-=1}editorDiv.style.left=xy.x+"px";editorDiv.style.top=xy.y+"px";editorDiv.display="block";if(!this.isAnalyze){generate_popup_list_var(xy.x+210,xy.y,false)}else{generate_popup_list_var(xy.x+410,xy.y+40,true)}if(!quietInput){this.quillEditor_.focus()}};Blockly.FieldWIMSEditor.prototype.getValue=function(){if(this.quillEditor_){return JSON.stringify(this.quillEditor_.getContents())}else{return""}};Blockly.FieldWIMSEditor.prototype.setValue=function(val){if(val){this.value=JSON.parse(val)}};Blockly.FieldWIMSEditor.prototype.render_=function(){};Blockly.FieldWIMSEditor.prototype.updateWidth=function(){};goog.provide("Blockly.ExternalDiv");Blockly.ExternalDiv.DIV=[];Blockly.ExternalDiv.owner=[];Blockly.ExternalDiv.activeDivId=null;Blockly.ExternalDiv.hide=function(){var activeIndex=-1;if(Blockly.ExternalDiv.DIV.length>0){for(var iDiv=0;iDiv<Blockly.ExternalDiv.DIV.length;iDiv++){var div=Blockly.ExternalDiv.DIV[iDiv];if(div.id==Blockly.ExternalDiv.activeDivId)activeIndex=iDiv}}if(activeIndex>=0){Blockly.ExternalDiv.owner[activeIndex].computePlaceholderImage_()}if(Blockly.ExternalDiv.DIV.length>0){for(var iDiv=0;iDiv<Blockly.ExternalDiv.DIV.length;iDiv++){var div=Blockly.ExternalDiv.DIV[iDiv];div.style.display="none";div.style.left="";div.style.top=""}}Blockly.ExternalDiv.activeDivId=null;$("#popup_var_blockly").remove()};Blockly.ExternalDiv.show=function(id){if(Blockly.ExternalDiv.DIV.length>0){Blockly.ExternalDiv.hide();for(var iDiv=0;iDiv<Blockly.ExternalDiv.DIV.length;iDiv++){if(Blockly.ExternalDiv.DIV[iDiv].id==id){var xy=goog.style.getViewportPageOffset(document);Blockly.ExternalDiv.DIV[iDiv].style.top=xy.y+"px";Blockly.ExternalDiv.DIV[iDiv].style.display="block";Blockly.ExternalDiv.activeDivId=id}}}};Blockly.ExternalDiv.dispose=function(id){if(Blockly.ExternalDiv.DIV.length>0){var iDiv=0;while(iDiv<Blockly.ExternalDiv.DIV.length){if(Blockly.ExternalDiv.DIV[iDiv].id==id){goog.dom.removeNode(Blockly.ExternalDiv.DIV[iDiv]);Blockly.ExternalDiv.DIV.splice(iDiv,1);Blockly.ExternalDiv.owner.splice(iDiv,1);if(Blockly.ExternalDiv.activeDivId==id)Blockly.ExternalDiv.activeDivId=null}iDiv++}}};Blockly.ExternalDiv.register=function(div,fieldEditor){var testExist=false;if(Blockly.ExternalDiv.DIV.length>0){for(var iDiv=0;iDiv<Blockly.ExternalDiv.DIV.length;iDiv++){if(Blockly.ExternalDiv.DIV[iDiv].id==div.id){console.log("Internal error in Blockly ExternalDiv: already registered div");testExist=true;break}}}if(!testExist){Blockly.ExternalDiv.DIV.push(div);Blockly.ExternalDiv.owner.push(fieldEditor)}};Blockly.hideChaff=function(opt_allowToolbox){Blockly.Tooltip.hide();Blockly.WidgetDiv.hide();Blockly.ExternalDiv.hide();if(!opt_allowToolbox){var workspace=Blockly.getMainWorkspace();if(workspace.toolbox_&&workspace.toolbox_.flyout_&&workspace.toolbox_.flyout_.autoClose){workspace.toolbox_.clearSelection()}}};"use strict";goog.provide("Blockly.OEF");goog.require("Blockly.Generator");Blockly.OEF=new Blockly.Generator("OEF");Blockly.OEF.addReservedWords("Blockly,"+"for,while,do,real,integer,matrix,function,wims,answer,"+"const,null,true,false,");Blockly.OEF.ORDER_ATOMIC=0;Blockly.OEF.ORDER_NEW=1.1;Blockly.OEF.ORDER_MEMBER=1.2;Blockly.OEF.ORDER_FUNCTION_CALL=2;Blockly.OEF.ORDER_INCREMENT=3;Blockly.OEF.ORDER_DECREMENT=3;Blockly.OEF.ORDER_BITWISE_NOT=4.1;Blockly.OEF.ORDER_UNARY_PLUS=4.2;Blockly.OEF.ORDER_UNARY_NEGATION=4.3;Blockly.OEF.ORDER_LOGICAL_NOT=4.4;Blockly.OEF.ORDER_TYPEOF=4.5;Blockly.OEF.ORDER_VOID=4.6;Blockly.OEF.ORDER_DELETE=4.7;Blockly.OEF.ORDER_DIVISION=5.1;Blockly.OEF.ORDER_MULTIPLICATION=5.2;Blockly.OEF.ORDER_MODULUS=5.3;Blockly.OEF.ORDER_SUBTRACTION=6.1;Blockly.OEF.ORDER_ADDITION=6.2;Blockly.OEF.ORDER_BITWISE_SHIFT=7;Blockly.OEF.ORDER_RELATIONAL=8;Blockly.OEF.ORDER_IN=8;Blockly.OEF.ORDER_INSTANCEOF=8;Blockly.OEF.ORDER_EQUALITY=9;Blockly.OEF.ORDER_BITWISE_AND=10;Blockly.OEF.ORDER_BITWISE_XOR=11;Blockly.OEF.ORDER_BITWISE_OR=12;Blockly.OEF.ORDER_LOGICAL_AND=13;Blockly.OEF.ORDER_LOGICAL_OR=14;Blockly.OEF.ORDER_CONDITIONAL=15;Blockly.OEF.ORDER_ASSIGNMENT=16;Blockly.OEF.ORDER_COMMA=17;Blockly.OEF.ORDER_NONE=99;Blockly.OEF.ORDER_OVERRIDES=[[Blockly.OEF.ORDER_FUNCTION_CALL,Blockly.OEF.ORDER_MEMBER],[Blockly.OEF.ORDER_FUNCTION_CALL,Blockly.OEF.ORDER_FUNCTION_CALL],[Blockly.OEF.ORDER_MEMBER,Blockly.OEF.ORDER_MEMBER],[Blockly.OEF.ORDER_MEMBER,Blockly.OEF.ORDER_FUNCTION_CALL],[Blockly.OEF.ORDER_LOGICAL_NOT,Blockly.OEF.ORDER_LOGICAL_NOT],[Blockly.OEF.ORDER_MULTIPLICATION,Blockly.OEF.ORDER_MULTIPLICATION],[Blockly.OEF.ORDER_ADDITION,Blockly.OEF.ORDER_ADDITION],[Blockly.OEF.ORDER_LOGICAL_AND,Blockly.OEF.ORDER_LOGICAL_AND],[Blockly.OEF.ORDER_LOGICAL_OR,Blockly.OEF.ORDER_LOGICAL_OR]];Blockly.OEF.init=function(workspace){Blockly.OEF.definitions_=Object.create(null);Blockly.OEF.functionNames_=Object.create(null);if(!Blockly.OEF.variableDB_){Blockly.OEF.variableDB_=new Blockly.Names(Blockly.OEF.RESERVED_WORDS_)}else{Blockly.OEF.variableDB_.reset()}var defvars=[];var variables=workspace.variableList;if(variables.length){for(var i=0;i<variables.length;i++){defvars[i]=Blockly.OEF.variableDB_.getName(variables[i],Blockly.Variables.NAME_TYPE)}Blockly.OEF.definitions_["variables"]=""}};Blockly.OEF.finish=function(code){var definitions=[];for(var name in Blockly.OEF.definitions_){definitions.push(Blockly.OEF.definitions_[name])}delete Blockly.OEF.definitions_;delete Blockly.OEF.functionNames_;Blockly.OEF.variableDB_.reset();return definitions.join("\n\n")+"\n\n\n"+code};Blockly.OEF.scrubNakedValue=function(line){return line+"\n"};Blockly.OEF.quote_=function(string){string=string.replace(/\\/g,"\\\\").replace(/\n/g,"\\\n").replace(/'/g,"\\'");return"'"+string+"'"};Blockly.OEF.scrub_=function(block,code){var commentCode="";if(!block.outputConnection||!block.outputConnection.targetConnection){var comment=block.getCommentText();comment=Blockly.utils.wrap(comment,Blockly.OEF.COMMENT_WRAP-3);if(comment){if(block.getProcedureDef){commentCode+="/**\n"+Blockly.OEF.prefixLines(comment+"\n"," * ")+" */\n"}else{commentCode+=Blockly.OEF.prefixLines(comment+"\n","// ")}}for(var i=0;i<block.inputList.length;i++){if(block.inputList[i].type==Blockly.INPUT_VALUE){var childBlock=block.inputList[i].connection.targetBlock();if(childBlock){var comment=Blockly.OEF.allNestedComments(childBlock);if(comment){commentCode+=Blockly.OEF.prefixLines(comment,"// ")}}}}}var nextBlock=block.nextConnection&&block.nextConnection.targetBlock();var nextCode=Blockly.OEF.blockToCode(nextBlock);return commentCode+code+nextCode};Blockly.OEF.getAdjusted=function(block,atId,opt_delta,opt_negate,opt_order){var delta=opt_delta||0;var order=opt_order||Blockly.OEF.ORDER_NONE;if(block.workspace.options.oneBasedIndex){delta--}var defaultAtIndex=block.workspace.options.oneBasedIndex?"1":"0";if(delta>0){var at=Blockly.OEF.valueToCode(block,atId,Blockly.OEF.ORDER_ADDITION)||defaultAtIndex}else if(delta<0){var at=Blockly.OEF.valueToCode(block,atId,Blockly.OEF.ORDER_SUBTRACTION)||defaultAtIndex}else if(opt_negate){var at=Blockly.OEF.valueToCode(block,atId,Blockly.OEF.ORDER_UNARY_NEGATION)||defaultAtIndex}else{var at=Blockly.OEF.valueToCode(block,atId,order)||defaultAtIndex}if(Blockly.isNumber(at)){at=parseFloat(at)+delta;if(opt_negate){at=-at}}else{if(delta>0){at=at+" + "+delta;var innerOrder=Blockly.OEF.ORDER_ADDITION}else if(delta<0){at=at+" - "+-delta;var innerOrder=Blockly.OEF.ORDER_SUBTRACTION}if(opt_negate){if(delta){at="-("+at+")"}else{at="-"+at}var innerOrder=Blockly.OEF.ORDER_UNARY_NEGATION}innerOrder=Math.floor(innerOrder);order=Math.floor(order);if(innerOrder&&order>=innerOrder){at="("+at+")"}}return at};var prepEditor;var analyseEditor;var SProgramEditor=function(){function SProgramEditor(type,idToolboxXml,idDiv,idArea){this.mArea=$("#"+idArea)[0];this.mDiv=$("#"+idDiv)[0];this.mType=type;this.mBlocklyWorkspace=Blockly.inject(this.mDiv,{media:"js_tools/blockly/media/",toolbox:document.getElementById(idToolboxXml),collapse:true,comments:true,trashcan:true,scrollbars:true,sounds:false,grid:{spacing:24,length:1,colour:"#ddd",snap:true},zoom:{controls:true,wheel:false,startScale:1,maxScale:2,minScale:.5,scaleSpeed:1.2}});var calling_object=this;$(window).resize(function(e){calling_object.onResize.call(calling_object,e)});this.onResize();Blockly.svgResize(this.mBlocklyWorkspace);this.build_header_blocks();this.mBlocklyWorkspace.addChangeListener(Blockly.Events.disableOrphans)}SProgramEditor.prototype.init=function(){};SProgramEditor.prototype.build_header_blocks=function(){if(this.mType=="prep"){var title=Blockly.Msg.WIMS_BKY_PREP_START}else if(this.mType=="analysis")title=Blockly.Msg.WIMS_BKY_ANALYSIS_START;title="   "+title+"   ";this.mFirstBlock=this.mBlocklyWorkspace.newBlock("wims_start");this.mFirstBlock.getField("START_TEXT").setValue(title);this.mFirstBlock.setDeletable(false);this.mFirstBlock.setMovable(false);this.mFirstBlock.initSvg();this.mFirstBlock.render();if(this.mType=="prep"){this.mDeclarationBlock=this.mBlocklyWorkspace.newBlock("wims_declaration");this.mDeclarationBlock.getField("DECLARATION_TEXT").setValue(Blockly.Msg.WIMS_BKY_PREP_DECLARATION);this.mDeclarationBlock.setDeletable(false);this.mDeclarationBlock.setMovable(false);this.mDeclarationBlock.initSvg();this.mDeclarationBlock.render();var parentConnection=this.mFirstBlock.nextConnection;var childConnection=this.mDeclarationBlock.previousConnection;parentConnection.connect(childConnection)}};SProgramEditor.prototype.load=function(xmlState){this.mBlocklyWorkspace.clear();this.build_header_blocks();var xmlTree=$.parseXML(xmlState);if(this.mType=="prep"){$(xmlTree).find("[name='DECLARATION']").remove();var xmlStateReduced=$(xmlTree).find("[type='wims_declaration']").children(":last-child").children().first().prop("outerHTML")}else{var xmlStateReduced=$(xmlTree).find("[type='wims_start']").children(":last-child").children().first().prop("outerHTML")}xmlStateReduced='<xml xmlns="http://www.w3.org/1999/xhtml">'+xmlStateReduced+"</xml>";var xmlStateDom=Blockly.Xml.textToDom(xmlStateReduced);var xmlStateFirst=$(xmlStateDom).children().first();if(xmlStateFirst.length>0){var xmlStateFirstId=xmlStateFirst[0].id;Blockly.Xml.domToWorkspace(xmlStateDom,this.mBlocklyWorkspace);var childConnection=this.mBlocklyWorkspace.getBlockById(xmlStateFirstId).previousConnection;if(this.mType=="prep"){var parentConnection=this.mDeclarationBlock.nextConnection}else{var parentConnection=this.mFirstBlock.nextConnection}parentConnection.connect(childConnection)}};SProgramEditor.prototype.onResize=function(){var element=this.mArea;var x=0;var y=0;do{x+=element.offsetLeft;y+=element.offsetTop;element=element.offsetParent}while(element);this.mDiv.style.left=x+"px";this.mDiv.style.top=y+"px";this.mDiv.style.width=this.mArea.offsetWidth+"px";this.mDiv.style.height=this.mArea.offsetHeight+"px"};return SProgramEditor}();$(document).ready(function(){prepEditor=new SProgramEditor("prep","RId_toolbox_programPrep","RId_programPrep_blockly","RId_programPrep");analyseEditor=new SProgramEditor("analysis","RId_toolbox_programAnalyse","RId_programAnalyse_blockly","RId_programAnalyse")});"use strict";goog.provide("Blockly.OEF.wims");goog.require("Blockly.OEF");Blockly.OEF["wims_start"]=function(block){return""};Blockly.OEF["wims_declaration"]=function(block){return Blockly.OEF.statementToCode(block,"DECLARATION")};Blockly.OEF["wims_editor"]=function(block){var editor=block.getField("WIMS_EDITOR").quillEditor_;editor.setContents(JSON.parse(block.getFieldValue("WIMS_EDITOR")));var editorTmp=new SEditor(editor);return[editorTmp.to_variable_value(),1]};Blockly.OEF["wims_up_down_editor"]=function(block){var editor=block.getField("WIMS_EDITOR").quillEditor_;editor.setContents(JSON.parse(block.getFieldValue("WIMS_EDITOR")));var editorTmp=new SEditor(editor);return editorTmp.to_variable_value()+"\n"};Blockly.OEF["wims_comment"]=function(block){var result=block.getFieldValue("COMMENT");return"//"+result+"\n"};Blockly.OEF["wims_variable_editor"]=function(block){var varName=Blockly.OEF.variableDB_.getName(block.getFieldValue("VARIABLE_CHOICE"),Blockly.Variables.NAME_TYPE);var editor=block.getField("WIMS_EDITOR").quillEditor_;editor.setContents(JSON.parse(block.getFieldValue("WIMS_EDITOR")));var editorTmp=new SEditor(editor);var type=variable_List[varName].type;return"\\"+type+"{ "+varName+" = "+editorTmp.to_variable_value()+"}\n"};Blockly.OEF["wims_if"]=function(block){var editor=block.getField("WIMS_EDITOR").quillEditor_;editor.setContents(JSON.parse(block.getFieldValue("WIMS_EDITOR")));var editorTmp=new SEditor(editor);var condition=editorTmp.to_variable_value();var branch1=Blockly.OEF.statementToCode(block,"DO");var branch2=Blockly.OEF.statementToCode(block,"ELSE");if(branch1==""||condition==""){return""}else if(branch2==""){return"\\if{"+condition+"}\n{"+branch1.substring(0,branch1.length-1)+"}\n"}else{return"\\if{"+condition+"}\n{"+branch1.substring(0,branch1.length-1)+"}\n{"+branch2.substring(0,branch2.length-1)+"}\n"}};Blockly.OEF["wims_for"]=function(block){var varName=Blockly.OEF.variableDB_.getName(block.getFieldValue("VARIABLE_CHOICE"),Blockly.Variables.NAME_TYPE);if(block.getField("START")){var start=String(Number(block.getFieldValue("START")))}else{var start=Blockly.OEF.valueToCode(block,"START",Blockly.OEF.ORDER_ASSIGNMENT)||"0"}if(block.getField("END")){var end=String(Number(block.getFieldValue("END")))}else{var end=Blockly.OEF.valueToCode(block,"END",Blockly.OEF.ORDER_ASSIGNMENT)||"0"}if(block.getField("STEP")){var step=String(Number(block.getFieldValue("STEP")))}else{var step=Blockly.OEF.valueToCode(block,"STEP",Blockly.OEF.ORDER_ASSIGNMENT)||"0"}var todo=Blockly.OEF.statementToCode(block,"DO");if(todo[todo.length-1]=="\n"){todo=todo.substring(0,todo.length-1)}if(todo==""){return""}else{return"\\for{"+varName+" = "+start+" to "+end+" step "+step+"}\n{"+todo+"}\n"}};Blockly.OEF["controls_repeat_ext"]=function(block){if(block.getField("TIMES")){var repeats=String(Number(block.getFieldValue("TIMES")))}else{var repeats=Blockly.OEF.valueToCode(block,"TIMES",Blockly.OEF.ORDER_ASSIGNMENT)||"0"}var branch=Blockly.OEF.statementToCode(block,"DO");branch=Blockly.OEF.addLoopTrap(branch,block.id);var code="";var loopVar=Blockly.OEF.variableDB_.getDistinctName("count",Blockly.Variables.NAME_TYPE);var endVar=repeats;if(!repeats.match(/^\w+$/)&&!Blockly.isNumber(repeats)){var endVar=Blockly.OEF.variableDB_.getDistinctName("repeat_end",Blockly.Variables.NAME_TYPE);code+="var "+endVar+" = "+repeats+";\n"}code+="for (var "+loopVar+" = 0; "+loopVar+" < "+endVar+"; "+loopVar+"++) {\n"+branch+"}\n";return code};Blockly.OEF["controls_repeat"]=Blockly.OEF["controls_repeat_ext"];Blockly.OEF["controls_whileUntil"]=function(block){var until=block.getFieldValue("MODE")=="UNTIL";var argument0=Blockly.OEF.valueToCode(block,"BOOL",until?Blockly.OEF.ORDER_LOGICAL_NOT:Blockly.OEF.ORDER_NONE)||"false";var branch=Blockly.OEF.statementToCode(block,"DO");branch=Blockly.OEF.addLoopTrap(branch,block.id);if(until){argument0="!"+argument0}return"while ("+argument0+") {\n"+branch+"}\n"};Blockly.OEF["controls_for"]=function(block){var variable0=Blockly.OEF.variableDB_.getName(block.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE);var argument0=Blockly.OEF.valueToCode(block,"FROM",Blockly.OEF.ORDER_ASSIGNMENT)||"0";var argument1=Blockly.OEF.valueToCode(block,"TO",Blockly.OEF.ORDER_ASSIGNMENT)||"0";var increment=Blockly.OEF.valueToCode(block,"BY",Blockly.OEF.ORDER_ASSIGNMENT)||"1";var branch=Blockly.OEF.statementToCode(block,"DO");branch=Blockly.OEF.addLoopTrap(branch,block.id);var code;if(Blockly.isNumber(argument0)&&Blockly.isNumber(argument1)&&Blockly.isNumber(increment)){var up=parseFloat(argument0)<=parseFloat(argument1);code="for ("+variable0+" = "+argument0+"; "+variable0+(up?" <= ":" >= ")+argument1+"; "+variable0;var step=Math.abs(parseFloat(increment));if(step==1){code+=up?"++":"--"}else{code+=(up?" += ":" -= ")+step}code+=") {\n"+branch+"}\n"}else{code="";var startVar=argument0;if(!argument0.match(/^\w+$/)&&!Blockly.isNumber(argument0)){startVar=Blockly.OEF.variableDB_.getDistinctName(variable0+"_start",Blockly.Variables.NAME_TYPE);code+="var "+startVar+" = "+argument0+";\n"}var endVar=argument1;if(!argument1.match(/^\w+$/)&&!Blockly.isNumber(argument1)){var endVar=Blockly.OEF.variableDB_.getDistinctName(variable0+"_end",Blockly.Variables.NAME_TYPE);code+="var "+endVar+" = "+argument1+";\n"}var incVar=Blockly.OEF.variableDB_.getDistinctName(variable0+"_inc",Blockly.Variables.NAME_TYPE);code+="var "+incVar+" = ";if(Blockly.isNumber(increment)){code+=Math.abs(increment)+";\n"}else{code+="Math.abs("+increment+");\n"}code+="if ("+startVar+" > "+endVar+") {\n";code+=Blockly.OEF.INDENT+incVar+" = -"+incVar+";\n";code+="}\n";code+="for ("+variable0+" = "+startVar+"; "+incVar+" >= 0 ? "+variable0+" <= "+endVar+" : "+variable0+" >= "+endVar+"; "+variable0+" += "+incVar+") {\n"+branch+"}\n"}return code};Blockly.OEF["controls_forEach"]=function(block){var variable0=Blockly.OEF.variableDB_.getName(block.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE);var argument0=Blockly.OEF.valueToCode(block,"LIST",Blockly.OEF.ORDER_ASSIGNMENT)||"[]";var branch=Blockly.OEF.statementToCode(block,"DO");branch=Blockly.OEF.addLoopTrap(branch,block.id);var code="";var listVar=argument0;if(!argument0.match(/^\w+$/)){listVar=Blockly.OEF.variableDB_.getDistinctName(variable0+"_list",Blockly.Variables.NAME_TYPE);code+="var "+listVar+" = "+argument0+";\n"}var indexVar=Blockly.OEF.variableDB_.getDistinctName(variable0+"_index",Blockly.Variables.NAME_TYPE);branch=Blockly.OEF.INDENT+variable0+" = "+listVar+"["+indexVar+"];\n"+branch;code+="for (var "+indexVar+" in "+listVar+") {\n"+branch+"}\n";return code};Blockly.OEF["controls_flow_statements"]=function(block){switch(block.getFieldValue("FLOW")){case"BREAK":return"break;\n";case"CONTINUE":return"continue;\n"}throw"Unknown flow statement."};"use strict";goog.provide("Blockly.OEF.analyse");goog.require("Blockly.OEF");Blockly.OEF["analyse_feedback"]=function(block){var editor=block.getField("WIMS_EDITOR_TEST").quillEditor_;editor.setContents(JSON.parse(block.getFieldValue("WIMS_EDITOR_TEST")));var editorTestTmp=new SEditor(editor);var valTestQuill=editorTestTmp.to_Blockly_Analyse();var editor2=block.getField("WIMS_EDITOR").quillEditor_;editor2.setContents(JSON.parse(block.getFieldValue("WIMS_EDITOR")));var editorTmp=new SEditor(editor2);var valQuill=editorTmp.to_Blockly_Analyse();if(valTestQuill==""||valQuill==""){return""}else{return"\\feedback{"+valTestQuill+"}{"+valQuill+"}\n"}};Blockly.OEF["analyse_hint"]=function(block){var editor=block.getField("WIMS_EDITOR").quillEditor_;editor.setContents(JSON.parse(block.getFieldValue("WIMS_EDITOR")));var editorTmp=new SEditor(editor);return"\\hint{"+editorTmp.to_OEFcode().substring(0,editorTmp.to_OEFcode().length-1)+"}\n"};"use strict";goog.provide("Blockly.OEF.logic");goog.require("Blockly.OEF");Blockly.OEF["controls_if"]=function(block){var n=0;var code="",branchCode,conditionCode;do{conditionCode=Blockly.OEF.valueToCode(block,"IF"+n,Blockly.OEF.ORDER_NONE)||"false";branchCode=Blockly.OEF.statementToCode(block,"DO"+n);code+=(n>0?"":"")+"\\if {"+conditionCode+"} \n{"+branchCode.substring(0,branchCode.length-1)+"}";++n}while(block.getInput("IF"+n));if(block.getInput("ELSE")){branchCode=Blockly.OEF.statementToCode(block,"ELSE");code+=" \n{"+branchCode+"}"}return code+"\n"};Blockly.OEF["controls_ifelse"]=Blockly.OEF["controls_if"];Blockly.OEF["logic_compare"]=function(block){var OPERATORS={EQ:"==",NEQ:"!=",LT:"<",LTE:"<=",GT:">",GTE:">="};var operator=OPERATORS[block.getFieldValue("OP")];var order=operator=="=="||operator=="!="?Blockly.OEF.ORDER_EQUALITY:Blockly.OEF.ORDER_RELATIONAL;var argument0=Blockly.OEF.valueToCode(block,"A",order)||"0";var argument1=Blockly.OEF.valueToCode(block,"B",order)||"0";var code=argument0+" "+operator+" "+argument1;return[code,order]};Blockly.OEF["logic_operation"]=function(block){var operator=block.getFieldValue("OP")=="AND"?"&&":"||";var order=operator=="&&"?Blockly.OEF.ORDER_LOGICAL_AND:Blockly.OEF.ORDER_LOGICAL_OR;var argument0=Blockly.OEF.valueToCode(block,"A",order);var argument1=Blockly.OEF.valueToCode(block,"B",order);if(!argument0&&!argument1){argument0="false";argument1="false"}else{var defaultArgument=operator=="&&"?"true":"false";if(!argument0){argument0=defaultArgument}if(!argument1){argument1=defaultArgument}}var code=argument0+" "+operator+" "+argument1;return[code,order]};Blockly.OEF["logic_negate"]=function(block){var order=Blockly.OEF.ORDER_LOGICAL_NOT;var argument0=Blockly.OEF.valueToCode(block,"BOOL",order)||"true";var code="!"+argument0;return[code,order]};Blockly.OEF["logic_boolean"]=function(block){var code=block.getFieldValue("BOOL")=="TRUE"?"true":"false";return[code,Blockly.OEF.ORDER_ATOMIC]};Blockly.OEF["logic_null"]=function(block){return["null",Blockly.OEF.ORDER_ATOMIC]};Blockly.OEF["logic_ternary"]=function(block){var value_if=Blockly.OEF.valueToCode(block,"IF",Blockly.OEF.ORDER_CONDITIONAL)||"false";var value_then=Blockly.OEF.valueToCode(block,"THEN",Blockly.OEF.ORDER_CONDITIONAL)||"null";var value_else=Blockly.OEF.valueToCode(block,"ELSE",Blockly.OEF.ORDER_CONDITIONAL)||"null";var code=value_if+" ? "+value_then+" : "+value_else;return[code,Blockly.OEF.ORDER_CONDITIONAL]};"use strict";goog.provide("Blockly.OEF.math");goog.require("Blockly.OEF");Blockly.OEF["math_number"]=function(block){var code=parseFloat(block.getFieldValue("NUM"));return[code,Blockly.OEF.ORDER_ATOMIC]};Blockly.OEF["math_arithmetic"]=function(block){var OPERATORS={ADD:[" + ",Blockly.OEF.ORDER_ADDITION],MINUS:[" - ",Blockly.OEF.ORDER_SUBTRACTION],MULTIPLY:[" * ",Blockly.OEF.ORDER_MULTIPLICATION],DIVIDE:[" / ",Blockly.OEF.ORDER_DIVISION],POWER:[null,Blockly.OEF.ORDER_COMMA]};var tuple=OPERATORS[block.getFieldValue("OP")];var operator=tuple[0];var order=tuple[1];var argument0=Blockly.OEF.valueToCode(block,"A",order)||"0";var argument1=Blockly.OEF.valueToCode(block,"B",order)||"0";var code;if(!operator){code="Math.pow("+argument0+", "+argument1+")";return[code,Blockly.OEF.ORDER_FUNCTION_CALL]}code=argument0+operator+argument1;return[code,order]};Blockly.OEF["math_single"]=function(block){var operator=block.getFieldValue("OP");var code;var arg;if(operator=="NEG"){arg=Blockly.OEF.valueToCode(block,"NUM",Blockly.OEF.ORDER_UNARY_NEGATION)||"0";if(arg[0]=="-"){arg=" "+arg}code="-"+arg;return[code,Blockly.OEF.ORDER_UNARY_NEGATION]}if(operator=="SIN"||operator=="COS"||operator=="TAN"){arg=Blockly.OEF.valueToCode(block,"NUM",Blockly.OEF.ORDER_DIVISION)||"0"}else{arg=Blockly.OEF.valueToCode(block,"NUM",Blockly.OEF.ORDER_NONE)||"0"}switch(operator){case"ABS":code="Math.abs("+arg+")";break;case"ROOT":code="Math.sqrt("+arg+")";break;case"LN":code="Math.log("+arg+")";break;case"EXP":code="Math.exp("+arg+")";break;case"POW10":code="Math.pow(10,"+arg+")";break;case"ROUND":code="Math.round("+arg+")";break;case"ROUNDUP":code="Math.ceil("+arg+")";break;case"ROUNDDOWN":code="Math.floor("+arg+")";break;case"SIN":code="Math.sin("+arg+" / 180 * Math.PI)";break;case"COS":code="Math.cos("+arg+" / 180 * Math.PI)";break;case"TAN":code="Math.tan("+arg+" / 180 * Math.PI)";break}if(code){return[code,Blockly.OEF.ORDER_FUNCTION_CALL]}switch(operator){case"LOG10":code="Math.log("+arg+") / Math.log(10)";break;case"ASIN":code="Math.asin("+arg+") / Math.PI * 180";break;case"ACOS":code="Math.acos("+arg+") / Math.PI * 180";break;case"ATAN":code="Math.atan("+arg+") / Math.PI * 180";break;default:throw"Unknown math operator: "+operator}return[code,Blockly.OEF.ORDER_DIVISION]};Blockly.OEF["math_constant"]=function(block){var CONSTANTS={PI:["Math.PI",Blockly.OEF.ORDER_MEMBER],E:["Math.E",Blockly.OEF.ORDER_MEMBER],GOLDEN_RATIO:["(1 + Math.sqrt(5)) / 2",Blockly.OEF.ORDER_DIVISION],SQRT2:["Math.SQRT2",Blockly.OEF.ORDER_MEMBER],SQRT1_2:["Math.SQRT1_2",Blockly.OEF.ORDER_MEMBER],INFINITY:["Infinity",Blockly.OEF.ORDER_ATOMIC]};return CONSTANTS[block.getFieldValue("CONSTANT")]};Blockly.OEF["math_number_property"]=function(block){var number_to_check=Blockly.OEF.valueToCode(block,"NUMBER_TO_CHECK",Blockly.OEF.ORDER_MODULUS)||"0";var dropdown_property=block.getFieldValue("PROPERTY");var code;if(dropdown_property=="PRIME"){var functionName=Blockly.OEF.provideFunction_("mathIsPrime",["function "+Blockly.OEF.FUNCTION_NAME_PLACEHOLDER_+"(n) {","  // https://en.wikipedia.org/wiki/Primality_test#Naive_methods","  if (n == 2 || n == 3) {","    return true;","  }","  // False if n is NaN, negative, is 1, or not whole.","  // And false if n is divisible by 2 or 3.","  if (isNaN(n) || n <= 1 || n % 1 != 0 || n % 2 == 0 ||"+" n % 3 == 0) {","    return false;","  }","  // Check all the numbers of form 6k +/- 1, up to sqrt(n).","  for (var x = 6; x <= Math.sqrt(n) + 1; x += 6) {","    if (n % (x - 1) == 0 || n % (x + 1) == 0) {","      return false;","    }","  }","  return true;","}"]);code=functionName+"("+number_to_check+")";return[code,Blockly.OEF.ORDER_FUNCTION_CALL]}switch(dropdown_property){case"EVEN":code=number_to_check+" % 2 == 0";break;case"ODD":code=number_to_check+" % 2 == 1";break;case"WHOLE":code=number_to_check+" % 1 == 0";break;case"POSITIVE":code=number_to_check+" > 0";break;case"NEGATIVE":code=number_to_check+" < 0";break;case"DIVISIBLE_BY":var divisor=Blockly.OEF.valueToCode(block,"DIVISOR",Blockly.OEF.ORDER_MODULUS)||"0";code=number_to_check+" % "+divisor+" == 0";break}return[code,Blockly.OEF.ORDER_EQUALITY]};Blockly.OEF["math_change"]=function(block){var argument0=Blockly.OEF.valueToCode(block,"DELTA",Blockly.OEF.ORDER_ADDITION)||"0";var varName=Blockly.OEF.variableDB_.getName(block.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE);return varName+" = (typeof "+varName+" == 'number' ? "+varName+" : 0) + "+argument0+";\n"};Blockly.OEF["math_round"]=Blockly.OEF["math_single"];Blockly.OEF["math_trig"]=Blockly.OEF["math_single"];Blockly.OEF["math_on_list"]=function(block){var func=block.getFieldValue("OP");var list,code;switch(func){case"SUM":list=Blockly.OEF.valueToCode(block,"LIST",Blockly.OEF.ORDER_MEMBER)||"[]";code=list+".reduce(function(x, y) {return x + y;})";break;case"MIN":list=Blockly.OEF.valueToCode(block,"LIST",Blockly.OEF.ORDER_COMMA)||"[]";code="Math.min.apply(null, "+list+")";break;case"MAX":list=Blockly.OEF.valueToCode(block,"LIST",Blockly.OEF.ORDER_COMMA)||"[]";code="Math.max.apply(null, "+list+")";break;case"AVERAGE":var functionName=Blockly.OEF.provideFunction_("mathMean",["function "+Blockly.OEF.FUNCTION_NAME_PLACEHOLDER_+"(myList) {","  return myList.reduce(function(x, y) {return x + y;}) / "+"myList.length;","}"]);list=Blockly.OEF.valueToCode(block,"LIST",Blockly.OEF.ORDER_NONE)||"[]";code=functionName+"("+list+")";break;case"MEDIAN":var functionName=Blockly.OEF.provideFunction_("mathMedian",["function "+Blockly.OEF.FUNCTION_NAME_PLACEHOLDER_+"(myList) {","  var localList = myList.filter(function (x) "+"{return typeof x == 'number';});","  if (!localList.length) return null;","  localList.sort(function(a, b) {return b - a;});","  if (localList.length % 2 == 0) {","    return (localList[localList.length / 2 - 1] + "+"localList[localList.length / 2]) / 2;","  } else {","    return localList[(localList.length - 1) / 2];","  }","}"]);list=Blockly.OEF.valueToCode(block,"LIST",Blockly.OEF.ORDER_NONE)||"[]";code=functionName+"("+list+")";break;case"MODE":var functionName=Blockly.OEF.provideFunction_("mathModes",["function "+Blockly.OEF.FUNCTION_NAME_PLACEHOLDER_+"(values) {","  var modes = [];","  var counts = [];","  var maxCount = 0;","  for (var i = 0; i < values.length; i++) {","    var value = values[i];","    var found = false;","    var thisCount;","    for (var j = 0; j < counts.length; j++) {","      if (counts[j][0] === value) {","        thisCount = ++counts[j][1];","        found = true;","        break;","      }","    }","    if (!found) {","      counts.push([value, 1]);","      thisCount = 1;","    }","    maxCount = Math.max(thisCount, maxCount);","  }","  for (var j = 0; j < counts.length; j++) {","    if (counts[j][1] == maxCount) {","        modes.push(counts[j][0]);","    }","  }","  return modes;","}"]);list=Blockly.OEF.valueToCode(block,"LIST",Blockly.OEF.ORDER_NONE)||"[]";code=functionName+"("+list+")";break;case"STD_DEV":var functionName=Blockly.OEF.provideFunction_("mathStandardDeviation",["function "+Blockly.OEF.FUNCTION_NAME_PLACEHOLDER_+"(numbers) {","  var n = numbers.length;","  if (!n) return null;","  var mean = numbers.reduce(function(x, y) {return x + y;}) / n;","  var variance = 0;","  for (var j = 0; j < n; j++) {","    variance += Math.pow(numbers[j] - mean, 2);","  }","  variance = variance / n;","  return Math.sqrt(variance);","}"]);list=Blockly.OEF.valueToCode(block,"LIST",Blockly.OEF.ORDER_NONE)||"[]";code=functionName+"("+list+")";break;case"RANDOM":var functionName=Blockly.OEF.provideFunction_("mathRandomList",["function "+Blockly.OEF.FUNCTION_NAME_PLACEHOLDER_+"(list) {","  var x = Math.floor(Math.random() * list.length);","  return list[x];","}"]);list=Blockly.OEF.valueToCode(block,"LIST",Blockly.OEF.ORDER_NONE)||"[]";code=functionName+"("+list+")";break;default:throw"Unknown operator: "+func}return[code,Blockly.OEF.ORDER_FUNCTION_CALL]};Blockly.OEF["math_modulo"]=function(block){var argument0=Blockly.OEF.valueToCode(block,"DIVIDEND",Blockly.OEF.ORDER_MODULUS)||"0";var argument1=Blockly.OEF.valueToCode(block,"DIVISOR",Blockly.OEF.ORDER_MODULUS)||"0";var code=argument0+" % "+argument1;return[code,Blockly.OEF.ORDER_MODULUS]};Blockly.OEF["math_constrain"]=function(block){var argument0=Blockly.OEF.valueToCode(block,"VALUE",Blockly.OEF.ORDER_COMMA)||"0";var argument1=Blockly.OEF.valueToCode(block,"LOW",Blockly.OEF.ORDER_COMMA)||"0";var argument2=Blockly.OEF.valueToCode(block,"HIGH",Blockly.OEF.ORDER_COMMA)||"Infinity";var code="Math.min(Math.max("+argument0+", "+argument1+"), "+argument2+")";return[code,Blockly.OEF.ORDER_FUNCTION_CALL]};Blockly.OEF["math_random_int"]=function(block){var argument0=Blockly.OEF.valueToCode(block,"FROM",Blockly.OEF.ORDER_COMMA)||"0";var argument1=Blockly.OEF.valueToCode(block,"TO",Blockly.OEF.ORDER_COMMA)||"0";var functionName=Blockly.OEF.provideFunction_("mathRandomInt",["function "+Blockly.OEF.FUNCTION_NAME_PLACEHOLDER_+"(a, b) {","  if (a > b) {","    // Swap a and b to ensure a is smaller.","    var c = a;","    a = b;","    b = c;","  }","  return Math.floor(Math.random() * (b - a + 1) + a);","}"]);var code=functionName+"("+argument0+", "+argument1+")";return[code,Blockly.OEF.ORDER_FUNCTION_CALL]};Blockly.OEF["math_random_float"]=function(block){return["Math.random()",Blockly.OEF.ORDER_FUNCTION_CALL]};"use strict";goog.provide("Blockly.OEF.variables");goog.require("Blockly.OEF");Blockly.OEF["variables_get"]=function(block){var code="\\"+Blockly.OEF.variableDB_.getName(block.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE);return["",Blockly.OEF.ORDER_ATOMIC]};Blockly.OEF["variables_set"]=function(block){return""};Blockly.OEF["wims_change_type"]=function(block){var varName=Blockly.OEF.variableDB_.getName(block.getFieldValue("VARIABLE_CHOICE"),Blockly.Variables.NAME_TYPE);var type=block.getFieldValue("TYPE");variable_List[varName].setType(type);return""};Blockly.OEF["wims_define_variable"]=function(block){var varName=Blockly.OEF.variableDB_.getName(block.getFieldValue("VARIABLE_CHOICE"),Blockly.Variables.NAME_TYPE);var type=block.getFieldValue("TYPE");var editor=block.getField("WIMS_EDITOR").quillEditor_;editor.setContents(JSON.parse(block.getFieldValue("WIMS_EDITOR")));var value=new SEditor(editor);variable_List[varName].setType(type);variable_List[varName].setValue(value.to_variable_value());return""};